
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Documentation: cryostorm Instrumentation Library &#8212; Instrumentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="_static/proof.css?v=b4b7a797" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="_static/tabs.js?v=3ee01567"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
const load = async () => {
    await mermaid.run();
    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_to_add_zoom = 1 === -1 ? all_mermaids.length : 1;
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");
    if(mermaids_to_add_zoom > 0) {
        var svgs = d3.selectAll(".mermaid[data-zoom-id=id-20de12fa-af73-4a55-a80d-bc8d9c087f92] svg");
        if(all_mermaids.length !== mermaids_processed.length) {
            // try again in a sec, wait for mermaids to load
            setTimeout(load, 200);
            return;
        } else if(svgs.size() !== mermaids_to_add_zoom) {
            // try again in a sec, wait for mermaids to load
            setTimeout(load, 200);
            return;
        } else {
            svgs.each(function() {
                var svg = d3.select(this);
                svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                var inner = svg.select("g");
                var zoom = d3.zoom().on("zoom", function(event) {
                    inner.attr("transform", event.transform);
                });
                svg.call(zoom);
            });
        }
    }
};

window.addEventListener("load", load);
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'temp';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Understanding Propagator Types in Distributed Tracing" href="propagator_types.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Instrumentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="concept.html">Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="flow.html">Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="propagator_types.html">Understanding Propagator Types in Distributed Tracing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Documentation: cryostorm Instrumentation Library</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/gao-hongnan/instrumentation/issues/new?title=Issue%20on%20page%20%2Ftemp.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button"
   title="Open an issue"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/temp.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Documentation: cryostorm Instrumentation Library</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-architecture-overview">2. System Architecture Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#application-layer-your-code-cryostorm">2.1 Application Layer (Your Code + <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#opentelemetry-collector-the-data-hub">2.2 OpenTelemetry Collector (The Data Hub)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backend-systems-storage-visualization">2.3 Backend Systems (Storage &amp; Visualization)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-concepts-and-code-structure-cryostorm-library">3. Core Concepts and Code Structure (<code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Library)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-files-and-their-purpose">3.1 Key Files and Their Purpose</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#central-facade-telemetry-class-telemetry-py">3.2 Central Facade: <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> Class (<code class="docutils literal notranslate"><span class="pre">telemetry.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-telemetrysettings-settings-py">3.3 Configuration: <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> (<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-components-the-builder-and-factory-patterns">3.4 Building Components: The Builder and Factory Patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#component-interfaces-telemetrycomponent-and-factory-interface-py">3.5 Component Interfaces: <code class="docutils literal notranslate"><span class="pre">TelemetryComponent</span></code> and <code class="docutils literal notranslate"><span class="pre">Factory</span></code> (<code class="docutils literal notranslate"><span class="pre">interface.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-constants-enums-constants-py">3.6 Defining Constants: Enums (<code class="docutils literal notranslate"><span class="pre">constants.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-your-service-resource-resource-py">3.7 Representing Your Service: <code class="docutils literal notranslate"><span class="pre">Resource</span></code> (<code class="docutils literal notranslate"><span class="pre">resource.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-traces-tracingcomponent-trace-py">3.8 Handling Traces: <code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">trace.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-metrics-metricscomponent-metric-py">3.9 Handling Metrics: <code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">metric.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-logs-loggingcomponent-log-py">3.10 Handling Logs: <code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">log.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-context-propagation-propagatorcomponent-propagator-py">3.11 Handling Context Propagation: <code class="docutils literal notranslate"><span class="pre">PropagatorComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">propagator.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-trace-volume-sampler-sampler-py">3.12 Controlling Trace Volume: <code class="docutils literal notranslate"><span class="pre">Sampler</span></code> (<code class="docutils literal notranslate"><span class="pre">sampler.py</span></code>)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-in-detail-settings-py">4. Configuration In Detail (<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-configuration">4.1 Loading Configuration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-telemetrysettings">4.2 Main <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serviceinfo">4.3 <code class="docutils literal notranslate"><span class="pre">ServiceInfo</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collectorendpoint">4.4 <code class="docutils literal notranslate"><span class="pre">CollectorEndpoint</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exportconfig">4.5 <code class="docutils literal notranslate"><span class="pre">ExportConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#propagationconfig">4.6 <code class="docutils literal notranslate"><span class="pre">PropagationConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracingconfig">4.7 <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metricsconfig">4.8 <code class="docutils literal notranslate"><span class="pre">MetricsConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loggingconfig">4.9 <code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use-cryostorm-examples">5. How to Use <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> (Examples)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialization">5.1 Initialization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-traces-spans">5.2 Creating Traces (Spans)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-metrics">5.3 Creating Metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-logs">5.4 Generating Logs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#context-propagation-manual">5.5 Context Propagation (Manual)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shutdown">5.6 Shutdown</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comprehensive-telemetry-flow-model-end-to-end">6. Comprehensive Telemetry Flow Model (End-to-End)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-0-initialization-and-configuration">6.1 Phase 0: Initialization and Configuration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-1-telemetry-generation-inside-your-app">6.2 Phase 1: Telemetry Generation (Inside Your App)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-2-context-propagation-linking-services">6.3 Phase 2: Context Propagation (Linking Services)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-3-sdk-processing-and-export-sending-data-out">6.4 Phase 3: SDK Processing and Export (Sending Data Out)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-4-collector-reception-and-processing-central-hub">6.5 Phase 4: Collector Reception and Processing (Central Hub)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-5-collector-export-to-backends">6.6 Phase 5: Collector Export (To Backends)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-6-backend-storage-and-indexing-saving-data">6.7 Phase 6: Backend Storage and Indexing (Saving Data)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-7-query-and-visualization-using-data">6.8 Phase 7: Query and Visualization (Using Data)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-demo-environment-docker-compose-local-yml">7. Understanding the Demo Environment (<code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-docker-compose">7.1 What is Docker Compose?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-otel-collector">7.2 Service: <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-jaeger">7.3 Service: <code class="docutils literal notranslate"><span class="pre">jaeger</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-prometheus">7.4 Service: <code class="docutils literal notranslate"><span class="pre">prometheus</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-web-demo-application">7.5 Service: <code class="docutils literal notranslate"><span class="pre">web</span></code> (Demo Application)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-otel-demo">7.6 Network: <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#volumes">7.7 Volumes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-collector-configuration-collector-config-yaml">8. Understanding the Collector Configuration (<code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#receivers">8.1 <code class="docutils literal notranslate"><span class="pre">receivers</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processors">8.2 <code class="docutils literal notranslate"><span class="pre">processors</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exporters">8.3 <code class="docutils literal notranslate"><span class="pre">exporters</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extensions">8.4 <code class="docutils literal notranslate"><span class="pre">extensions</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-pipelines">8.5 <code class="docutils literal notranslate"><span class="pre">service</span></code> (Pipelines)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resilience-and-lifecycle-management">9. Resilience and Lifecycle Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fault-tolerance">9.1 Fault Tolerance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lifecycle-management">9.2 Lifecycle Management</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-considerations">9.3 Performance Considerations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extensions-and-customizations">10. Extensions and Customizations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-exporters">10.1 Custom Exporters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-processors">10.2 Custom Processors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-samplers">10.3 Custom Samplers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backend-integrations">10.4 Backend Integrations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">11. Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="documentation-cryostorm-instrumentation-library">
<h1>Documentation: cryostorm Instrumentation Library<a class="headerlink" href="#documentation-cryostorm-instrumentation-library" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://twitter.com/gaohongnan"><img alt="Twitter Handle" src="https://img.shields.io/badge/Twitter-&#64;gaohongnan-blue?style=social&amp;logo=twitter" /></a>
<a class="reference external" href="https://linkedin.com/in/gao-hongnan"><img alt="LinkedIn Profile" src="https://img.shields.io/badge/&#64;gaohongnan-blue?style=social&amp;logo=linkedin" /></a></p>
<hr class="docutils" />
<section id="system-architecture-overview">
<h2>2. System Architecture Overview<a class="headerlink" href="#system-architecture-overview" title="Link to this heading">#</a></h2>
<p>To understand how <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> fits in, let’s look at the typical components
involved in collecting and viewing telemetry data.</p>
<pre data-zoom-id="id-20de12fa-af73-4a55-a80d-bc8d9c087f92" class="mermaid">
        flowchart TB
    %% Application and SDK
    subgraph &quot;Application Layer&quot;
        App[&quot;Application Code&quot;]
        TelemFacade[&quot;Telemetry Facade&quot;]

        subgraph &quot;OpenTelemetry SDK&quot;
            TracerProvider[&quot;TracerProvider&quot;]
            MeterProvider[&quot;MeterProvider&quot;]
            LoggerProvider[&quot;LoggerProvider&quot;]
        end

        subgraph &quot;SDK Processors&quot;
            BatchSpanProcessor[&quot;BatchSpanProcessor&quot;]
            PeriodicMetricReader[&quot;PeriodicMetricReader&quot;]
            BatchLogProcessor[&quot;BatchLogProcessor&quot;]
        end

        subgraph &quot;SDK Exporters&quot;
            OTLPTraceExporter[&quot;OTLPSpanExporter&quot;]
            OTLPMetricExporter[&quot;OTLPMetricExporter&quot;]
            OTLPLogExporter[&quot;OTLPLogExporter&quot;]
        end
    end

    %% OTLP Protocol
    OTLP[&quot;OTLP/gRPC Protocol (4317)&quot;]
    OTLPHTTP[&quot;OTLP/HTTP Protocol (4318)&quot;]

    %% Collector Configuration
    subgraph &quot;OpenTelemetry Collector&quot;
        subgraph &quot;Collector Extensions&quot;
            HealthCheck[&quot;Health Check (13133)&quot;]
            PProf[&quot;PProf Profiling (1777)&quot;]
            ZPages[&quot;ZPages Diagnostics (55679)&quot;]
        end

        subgraph &quot;Collector Receivers&quot;
            OTLPReceiver[&quot;OTLP Receiver (gRPC/HTTP)&quot;]
        end

        subgraph &quot;Collector Processors&quot;
            BatchProcessor[&quot;Batch Processor&quot;]
            MemoryLimiter[&quot;Memory Limiter&quot;]
            SamplingProcessor[&quot;Sampling Processor&quot;]
        end

        subgraph &quot;Collector Exporters&quot;
            DebugExporter[&quot;Debug Exporter&quot;]
            PromExporter[&quot;Prometheus Exporter (8889)&quot;]
            OTLPJaegerExporter[&quot;OTLP Exporter (to Jaeger)&quot;]
        end

        subgraph &quot;Collector Pipelines&quot;
            TracePipeline[&quot;Traces Pipeline&quot;]
            MetricsPipeline[&quot;Metrics Pipeline&quot;]
            LogsPipeline[&quot;Logs Pipeline&quot;]
        end
    end

    %% Backend Systems
    subgraph &quot;Observability Backends&quot;
        Prometheus[&quot;Prometheus&quot;]
        Jaeger[&quot;Jaeger&quot;]
        Loki[&quot;Loki (Future)&quot;]
        Alerting[&quot;Alerting Systems&quot;]
    end

    %% Connections - Application to Collector
    App --&gt; TelemFacade
    TelemFacade --&gt; TracerProvider
    TelemFacade --&gt; MeterProvider
    TelemFacade --&gt; LoggerProvider

    TracerProvider --&gt; BatchSpanProcessor
    MeterProvider --&gt; PeriodicMetricReader
    LoggerProvider --&gt; BatchLogProcessor

    BatchSpanProcessor --&gt; OTLPTraceExporter
    PeriodicMetricReader --&gt; OTLPMetricExporter
    BatchLogProcessor --&gt; OTLPLogExporter

    OTLPTraceExporter --&gt; OTLP
    OTLPMetricExporter --&gt; OTLP
    OTLPLogExporter --&gt; OTLP

    OTLPTraceExporter -.-&gt; OTLPHTTP
    OTLPMetricExporter -.-&gt; OTLPHTTP
    OTLPLogExporter -.-&gt; OTLPHTTP

    %% Connections - OTLP to Collector
    OTLP --&gt; OTLPReceiver
    OTLPHTTP --&gt; OTLPReceiver

    %% Connections - Extensions
    HealthCheck -.-&gt; OTLPReceiver
    PProf -.-&gt; OTLPReceiver
    ZPages -.-&gt; OTLPReceiver

    %% Inside Pipeline Connections - Based on config file
    OTLPReceiver --&gt; TracePipeline
    OTLPReceiver --&gt; MetricsPipeline
    OTLPReceiver --&gt; LogsPipeline

    TracePipeline --&gt; BatchProcessor
    BatchProcessor --&gt; MemoryLimiter
    MemoryLimiter --&gt; SamplingProcessor
    SamplingProcessor --&gt; OTLPJaegerExporter
    SamplingProcessor --&gt; DebugExporter

    MetricsPipeline --&gt; BatchProcessor
    BatchProcessor --&gt; PromExporter
    BatchProcessor --&gt; DebugExporter

    LogsPipeline --&gt; BatchProcessor
    BatchProcessor --&gt; DebugExporter

    %% Connections - Collector Exporters to Backends
    PromExporter --&gt; Prometheus
    OTLPJaegerExporter --&gt; Jaeger
    DebugExporter -.-&gt; Loki

    %% Connections - Backends to Alerting
    Prometheus --&gt; Alerting

    %% Styling
    classDef application fill:#f8d7da,stroke:#dc3545,stroke-width:2px
    classDef sdk fill:#d1e7dd,stroke:#198754,stroke-width:2px
    classDef sdkProcessor fill:#fff3cd,stroke:#ffc107,stroke-width:2px
    classDef sdkExporter fill:#cff4fc,stroke:#0dcaf0,stroke-width:2px
    classDef protocol fill:#e2e3e5,stroke:#6c757d,stroke-width:2px

    classDef collectorReceiver fill:#d0bfff,stroke:#6f42c1,stroke-width:2px
    classDef collectorProcessor fill:#ffc107,stroke:#fd7e14,stroke-width:2px
    classDef collectorExporter fill:#20c997,stroke:#198754,stroke-width:2px
    classDef collectorPipeline fill:#dee2e6,stroke:#6c757d,stroke-width:2px,stroke-dasharray: 5 5
    classDef collectorExtension fill:#f8f9fa,stroke:#212529,stroke-width:2px

    classDef backend fill:#adb5bd,stroke:#495057,stroke-width:2px

    %% Apply styles
    class App,TelemFacade application
    class TracerProvider,MeterProvider,LoggerProvider sdk
    class BatchSpanProcessor,PeriodicMetricReader,BatchLogProcessor sdkProcessor
    class OTLPTraceExporter,OTLPMetricExporter,OTLPLogExporter sdkExporter
    class OTLP,OTLPHTTP protocol

    class OTLPReceiver collectorReceiver
    class BatchProcessor,MemoryLimiter,SamplingProcessor collectorProcessor
    class PromExporter,OTLPJaegerExporter,DebugExporter collectorExporter
    class TracePipeline,MetricsPipeline,LogsPipeline collectorPipeline
    class HealthCheck,PProf,ZPages collectorExtension

    class Prometheus,Jaeger,Loki,Alerting backend
    </pre><section id="application-layer-your-code-cryostorm">
<h3>2.1 Application Layer (Your Code + <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code>)<a class="headerlink" href="#application-layer-your-code-cryostorm" title="Link to this heading">#</a></h3>
<p>This is where your application logic lives and where telemetry data originates.</p>
<ul class="simple">
<li><p><strong>Application Code:</strong> Your specific business logic (e.g., a web request
handler, a data processing task).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Telemetry Facade (<code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> class):</strong> The main interface
provided by <em>this</em> library. You interact with this object to initialize
telemetry and generate data (spans, metrics, logs). It hides much of the
underlying OTel complexity.</p></li>
<li><p><strong>OpenTelemetry SDK (Python Libraries):</strong> The core OpenTelemetry libraries
that <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> uses behind the scenes. These implement the OTel
specification.</p>
<ul>
<li><p><strong>SDK Processors:</strong> Components within the SDK that process telemetry
data before it’s sent out. Common examples include:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">BatchSpanProcessor</span></code>: Groups multiple spans together before sending
to improve efficiency.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SimpleSpanProcessor</span></code>: Sends each span individually (less efficient,
often used for debugging).</p></li>
</ul>
</li>
<li><p><strong>SDK Exporters:</strong> Components within the SDK responsible for formatting
and sending the processed telemetry data to a destination (usually the
OTel Collector). Examples include:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">OTLPSpanExporter</span></code>: Sends data using the OpenTelemetry Protocol
(OTLP) format.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ConsoleSpanExporter</span></code>: Prints data to the console (useful for
debugging).</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Resource:</strong> Represents the entity producing telemetry (e.g., your
service). It includes identifying attributes like service name, version, and
environment.</p></li>
</ul>
</section>
<section id="opentelemetry-collector-the-data-hub">
<h3>2.2 OpenTelemetry Collector (The Data Hub)<a class="headerlink" href="#opentelemetry-collector-the-data-hub" title="Link to this heading">#</a></h3>
<p>The <strong>OpenTelemetry Collector (OTel Collector)</strong> is a separate, standalone
application (often run as a container, see <code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>). It acts
as a central hub for receiving, processing, and exporting telemetry data. It’s
highly recommended in most production setups.</p>
<ul class="simple">
<li><p><strong>Why use a Collector?</strong></p>
<ul>
<li><p><strong>Decoupling:</strong> Your application only needs to know how to send data to
the Collector (using OTLP). The Collector handles sending it to various
backend systems (Jaeger, Prometheus, etc.). You can change backends
without changing your application code.</p></li>
<li><p><strong>Efficiency:</strong> The Collector can batch data more effectively, reducing
network load.</p></li>
<li><p><strong>Processing:</strong> It can perform advanced processing like filtering,
adding extra attributes (e.g., Kubernetes metadata), tail-based sampling
(making sampling decisions based on the <em>entire</em> trace), and calculating
rates.</p></li>
<li><p><strong>Resilience:</strong> It can buffer data if a backend is temporarily
unavailable.</p></li>
</ul>
</li>
<li><p><strong>Collector Components:</strong></p>
<ul>
<li><p><strong>Receivers:</strong> Listen for incoming data from applications (e.g., <code class="docutils literal notranslate"><span class="pre">otlp</span></code>
receiver listens for OTLP data on ports 4317/4318).</p></li>
<li><p><strong>Processors:</strong> Modify or filter data as it flows through the Collector
(e.g., <code class="docutils literal notranslate"><span class="pre">batch</span></code> processor for further batching, <code class="docutils literal notranslate"><span class="pre">memory_limiter</span></code> to
prevent crashes under heavy load).</p></li>
<li><p><strong>Exporters:</strong> Send processed data to final destinations (e.g., <code class="docutils literal notranslate"><span class="pre">otlp</span></code>
exporter to send traces to Jaeger, <code class="docutils literal notranslate"><span class="pre">prometheus</span></code> exporter to expose
metrics for Prometheus to scrape).</p></li>
<li><p><strong>Extensions:</strong> Provide additional capabilities like health checks
(<code class="docutils literal notranslate"><span class="pre">health_check</span></code>) or performance profiling (<code class="docutils literal notranslate"><span class="pre">pprof</span></code>).</p></li>
<li><p><strong>Service Pipelines:</strong> Define how data flows from receivers through
processors to exporters for each signal type (traces, metrics, logs).</p></li>
</ul>
</li>
</ul>
<p><em>(See Section 8 for a detailed breakdown of the <code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code> file)</em></p>
</section>
<section id="backend-systems-storage-visualization">
<h3>2.3 Backend Systems (Storage &amp; Visualization)<a class="headerlink" href="#backend-systems-storage-visualization" title="Link to this heading">#</a></h3>
<p>These are the final destinations where telemetry data is stored, queried, and
visualized.</p>
<ul class="simple">
<li><p><strong>Jaeger:</strong> An open-source distributed tracing system. It stores trace data
received from the Collector and provides a Web UI to search and visualize
request flows across services.</p></li>
<li><p><strong>Prometheus:</strong> An open-source time-series database and monitoring system.
It periodically “scrapes” (pulls) metrics data from configured targets (like
the OTel Collector’s Prometheus exporter endpoint) and stores it. It has its
own query language (PromQL) and basic UI.</p></li>
<li><p><strong>Loki (Future):</strong> An open-source log aggregation system, often used with
Prometheus and Grafana. It’s designed to efficiently store and query logs
based on labels (similar to Prometheus). <em>Note: The current setup uses the
<code class="docutils literal notranslate"><span class="pre">debug</span></code> exporter for logs, sending them to the Collector’s console output,
but Loki could be added.</em></p></li>
<li><p><strong>Grafana:</strong> An open-source visualization and analytics platform. It
connects to various data sources (like Jaeger, Prometheus, Loki) to create
unified dashboards, visualize trends, and set up alerts.</p></li>
</ul>
<p><em>(See Section 7 for how these are run using <code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>)</em></p>
</section>
</section>
<hr class="docutils" />
<section id="core-concepts-and-code-structure-cryostorm-library">
<h2>3. Core Concepts and Code Structure (<code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Library)<a class="headerlink" href="#core-concepts-and-code-structure-cryostorm-library" title="Link to this heading">#</a></h2>
<p>This section dives into the specific Python code components provided by the
<code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> library.</p>
<section id="key-files-and-their-purpose">
<h3>3.1 Key Files and Their Purpose<a class="headerlink" href="#key-files-and-their-purpose" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">telemetry.py</span></code>: Contains the main <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> facade class, the entry point
for using the library. Also includes the <code class="docutils literal notranslate"><span class="pre">TelemetryBuilder</span></code> and
<code class="docutils literal notranslate"><span class="pre">TelemetryComponents</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">settings.py</span></code>: Defines Pydantic models (<code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code>,
<code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code>, etc.) for configuring the library, primarily through
environment variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">interface.py</span></code>: Defines base abstract classes (<code class="docutils literal notranslate"><span class="pre">TelemetryComponent</span></code>,
<code class="docutils literal notranslate"><span class="pre">Factory</span></code>) used throughout the library.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">constants.py</span></code>: Defines Enumerations (Enums) for configuration options
(e.g., <code class="docutils literal notranslate"><span class="pre">ExporterType</span></code>, <code class="docutils literal notranslate"><span class="pre">ProcessorType</span></code>, <code class="docutils literal notranslate"><span class="pre">EnvironmentType</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resource.py</span></code>: Contains <code class="docutils literal notranslate"><span class="pre">ResourceFactory</span></code> for creating the OpenTelemetry
<code class="docutils literal notranslate"><span class="pre">Resource</span></code> object that identifies your service.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">propagator.py</span></code>: Contains <code class="docutils literal notranslate"><span class="pre">PropagatorFactory</span></code> and <code class="docutils literal notranslate"><span class="pre">PropagatorComponent</span></code> for
setting up context propagation (linking traces across services).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trace.py</span></code>: Contains <code class="docutils literal notranslate"><span class="pre">SpanExporterFactory</span></code>, <code class="docutils literal notranslate"><span class="pre">SpanProcessorFactory</span></code>, and
<code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code> for setting up the tracing pipeline.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric.py</span></code>: Contains <code class="docutils literal notranslate"><span class="pre">MetricExporterFactory</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricReaderFactory</span></code>, and
<code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code> for setting up the metrics pipeline.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log.py</span></code>: Contains <code class="docutils literal notranslate"><span class="pre">LogExporterFactory</span></code>, <code class="docutils literal notranslate"><span class="pre">LogProcessorFactory</span></code>, and
<code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code> for setting up the logging pipeline.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sampler.py</span></code>: Contains <code class="docutils literal notranslate"><span class="pre">SamplerFactory</span></code> for creating trace samplers
(determining which traces to record).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">types_.py</span></code>: Defines type hints and generics used within the library.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>: Makes the directory a Python package (currently empty).</p></li>
</ul>
</section>
<section id="central-facade-telemetry-class-telemetry-py">
<h3>3.2 Central Facade: <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> Class (<code class="docutils literal notranslate"><span class="pre">telemetry.py</span></code>)<a class="headerlink" href="#central-facade-telemetry-class-telemetry-py" title="Link to this heading">#</a></h3>
<p>This is the <strong>primary class</strong> you will interact with.</p>
<ul class="simple">
<li><p><strong>Purpose:</strong> To provide a single, unified, and simplified interface for
initializing and using OpenTelemetry tracing, metrics, and logging within
your application. It hides the complexity of configuring and connecting the
various underlying OTel SDK components.</p></li>
<li><p><strong>Singleton Pattern:</strong> The <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> class is implemented as a
<strong>thread-safe singleton</strong>.</p>
<ul>
<li><p><strong>What is a Singleton?</strong> A design pattern that ensures a class has only
<em>one</em> instance throughout the application’s lifetime and provides a
global point of access to it.</p></li>
<li><p><strong>Why use it here?</strong> Telemetry setup is typically done once per
application process. Using a singleton prevents accidental multiple
initializations (which can cause issues) and makes it easy to access the
configured telemetry tools (tracer, meter, logger) from anywhere in your
code via <code class="docutils literal notranslate"><span class="pre">Telemetry.get_instance()</span></code>.</p></li>
<li><p><strong>Thread-Safety:</strong> The <code class="docutils literal notranslate"><span class="pre">threading.RLock</span></code> ensures that even if multiple
threads try to initialize or access the instance concurrently, the
process remains safe and consistent.</p></li>
</ul>
</li>
<li><p><strong>Initialization:</strong></p>
<ul>
<li><p>You typically create the instance once using
<code class="docutils literal notranslate"><span class="pre">Telemetry.from_settings(settings_object)</span></code>.</p></li>
<li><p>Internally, it uses <code class="docutils literal notranslate"><span class="pre">TelemetryBuilder</span></code> to construct all necessary
components (<code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code>, etc.) based on the
provided <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code>.</p></li>
<li><p>It then calls <code class="docutils literal notranslate"><span class="pre">setup_all()</span></code> on the components to perform the actual OTel
SDK configuration (e.g., setting global providers).</p></li>
</ul>
</li>
<li><p><strong>Key Properties/Methods:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">tracer</span></code>: Provides access to the configured OTel <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> object (for
creating spans). Returns <code class="docutils literal notranslate"><span class="pre">None</span></code> or a <code class="docutils literal notranslate"><span class="pre">NoOpTracer</span></code> if tracing is disabled
or not initialized.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">meter</span></code>: Provides access to the configured OTel <code class="docutils literal notranslate"><span class="pre">Meter</span></code> object (for
creating metrics). Returns <code class="docutils literal notranslate"><span class="pre">None</span></code> or a <code class="docutils literal notranslate"><span class="pre">NoOpMeter</span></code> if metrics are
disabled or not initialized.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logger</span></code>: Provides access to a standard Python <code class="docutils literal notranslate"><span class="pre">logging.Logger</span></code> that has
been configured to automatically include trace context (trace ID, span
ID) in log records.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">propagator</span></code>: Provides access to the configured OTel <code class="docutils literal notranslate"><span class="pre">TextMapPropagator</span></code>
(for context propagation).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start_as_current_span(...)</span></code>: A convenient wrapper around the OTel
tracer’s method to start a new trace span and make it the active one in
the current context.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">traced(...)</span></code>: A decorator to automatically wrap functions or methods in
a trace span.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">create_counter(...)</span></code>, <code class="docutils literal notranslate"><span class="pre">create_histogram(...)</span></code>,
<code class="docutils literal notranslate"><span class="pre">create_up_down_counter(...)</span></code>: Wrappers to create different types of
metric instruments using the configured meter.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log(...)</span></code>: A method to log messages using the trace-aware logger.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inject_context(...)</span></code>, <code class="docutils literal notranslate"><span class="pre">extract_context(...)</span></code>: Methods to handle context
propagation for distributed tracing (adding/reading trace headers).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shutdown()</span></code>: Properly shuts down all underlying OTel components,
ensuring buffered data is flushed (exported). Crucial to call this
before your application exits.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reset()</span></code>: A class method primarily for testing, allowing the singleton
instance to be shut down and reset.</p></li>
</ul>
</li>
</ul>
</section>
<section id="configuration-telemetrysettings-settings-py">
<h3>3.3 Configuration: <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> (<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>)<a class="headerlink" href="#configuration-telemetrysettings-settings-py" title="Link to this heading">#</a></h3>
<p>This module uses <strong>Pydantic</strong>, a popular Python library for data validation and
settings management.</p>
<ul class="simple">
<li><p><strong>Purpose:</strong> To define the structure of all configuration options for the
<code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> library and load them, typically from environment variables.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">BaseSettings</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> inherits from Pydantic’s
<code class="docutils literal notranslate"><span class="pre">BaseSettings</span></code>, which automatically attempts to load values from environment
variables. It uses a <code class="docutils literal notranslate"><span class="pre">__</span></code> (double underscore) as the nested delimiter (e.g.,
the environment variable <code class="docutils literal notranslate"><span class="pre">TRACING__EXPORTER_TYPE</span></code> maps to
<code class="docutils literal notranslate"><span class="pre">settings.tracing.exporter_type</span></code>).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">BaseConfig</span></code>:</strong> A base Pydantic model used by all configuration
sub-models. It enforces settings like <code class="docutils literal notranslate"><span class="pre">frozen=True</span></code> (making settings
immutable after creation) and <code class="docutils literal notranslate"><span class="pre">extra=&quot;forbid&quot;</span></code> (preventing unexpected
configuration fields).</p></li>
<li><p><strong>Structure:</strong> <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> contains nested Pydantic models for
different aspects:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ServiceInfo</span></code>: Basic info about your application (name, version,
environment).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PropagationConfig</span></code>: Settings for context propagation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code>: Settings for distributed tracing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MetricsConfig</span></code>: Settings for metrics collection.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code>: Settings for logging.</p></li>
</ul>
</li>
<li><p><strong>Validation:</strong> Pydantic automatically validates the types and constraints
(e.g., <code class="docutils literal notranslate"><span class="pre">gt=0</span></code> for positive numbers, <code class="docutils literal notranslate"><span class="pre">ge=0.0,</span> <span class="pre">le=1.0</span></code> for rates) of the
settings when loaded.</p></li>
<li><p><strong>Defaults:</strong> Sensible default values are provided for most settings.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">get_settings()</span></code>:</strong> A cached function to load and return the
<code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> instance, ensuring settings are loaded only once.</p></li>
</ul>
<p><em>(See Section 4 for a detailed breakdown of all configuration options)</em></p>
</section>
<section id="building-components-the-builder-and-factory-patterns">
<h3>3.4 Building Components: The Builder and Factory Patterns<a class="headerlink" href="#building-components-the-builder-and-factory-patterns" title="Link to this heading">#</a></h3>
<p>The library uses two common design patterns for creating objects:</p>
<ol class="arabic simple">
<li><p><strong>Builder Pattern (<code class="docutils literal notranslate"><span class="pre">TelemetryBuilder</span></code> in <code class="docutils literal notranslate"><span class="pre">telemetry.py</span></code>):</strong></p>
<ul class="simple">
<li><p><strong>What:</strong> A pattern used to construct complex objects step-by-step. The
<code class="docutils literal notranslate"><span class="pre">TelemetryBuilder</span></code> takes the <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> and has methods like
<code class="docutils literal notranslate"><span class="pre">build_resource()</span></code>, <code class="docutils literal notranslate"><span class="pre">build_tracing()</span></code>, <code class="docutils literal notranslate"><span class="pre">build_metrics()</span></code>, etc. The final
<code class="docutils literal notranslate"><span class="pre">build()</span></code> method assembles the complete <code class="docutils literal notranslate"><span class="pre">TelemetryComponents</span></code> object.</p></li>
<li><p><strong>Why:</strong> It separates the complex construction logic of the entire
telemetry setup from the main <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> facade class. It makes the
creation process more manageable and allows for potential flexibility in
the future (e.g., omitting certain components).</p></li>
</ul>
</li>
<li><p><strong>Factory Pattern (<code class="docutils literal notranslate"><span class="pre">*Factory</span></code> classes in <code class="docutils literal notranslate"><span class="pre">resource.py</span></code>, <code class="docutils literal notranslate"><span class="pre">trace.py</span></code>, etc.):</strong></p>
<ul class="simple">
<li><p><strong>What:</strong> A pattern where a dedicated “factory” object is responsible
for creating instances of other objects. For example,
<code class="docutils literal notranslate"><span class="pre">SpanExporterFactory</span></code> knows how to create different types of
<code class="docutils literal notranslate"><span class="pre">SpanExporter</span></code> (Console, OTLP) based on configuration.</p></li>
<li><p><strong>Why:</strong></p>
<ul>
<li><p><strong>Decoupling:</strong> The code that <em>uses</em> an exporter (e.g.,
<code class="docutils literal notranslate"><span class="pre">SpanProcessorFactory</span></code>) doesn’t need to know the specific details of
<em>how</em> each exporter type is created. It just asks the factory for
one.</p></li>
<li><p><strong>Centralized Creation Logic:</strong> The logic for creating a specific
type of object (like a <code class="docutils literal notranslate"><span class="pre">SpanExporter</span></code>) is contained within its
corresponding factory.</p></li>
<li><p><strong>Configuration:</strong> Factories often take configuration parameters (or
a settings object) to customize the object they create. The
<code class="docutils literal notranslate"><span class="pre">from_settings</span></code> class methods are a convention in this library to
create a factory instance directly from the main
<code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
</ol>
</section>
<section id="component-interfaces-telemetrycomponent-and-factory-interface-py">
<h3>3.5 Component Interfaces: <code class="docutils literal notranslate"><span class="pre">TelemetryComponent</span></code> and <code class="docutils literal notranslate"><span class="pre">Factory</span></code> (<code class="docutils literal notranslate"><span class="pre">interface.py</span></code>)<a class="headerlink" href="#component-interfaces-telemetrycomponent-and-factory-interface-py" title="Link to this heading">#</a></h3>
<p>This module defines abstract base classes (interfaces) that enforce a common
structure for components and factories.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">TelemetryComponent</span></code> (Abstract Base Class - ABC):</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Defines the basic contract for major telemetry parts
(Tracing, Metrics, Logging, Propagator).</p></li>
<li><p><strong>Methods:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">setup()</span></code>: An abstract method that each component <em>must</em> implement.
This method contains the logic to initialize and configure the
specific OpenTelemetry aspect (e.g., setting up the
<code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shutdown()</span></code>: A method (optional to override) for cleaning up
resources when the application stops (e.g., flushing exporters).</p></li>
</ul>
</li>
<li><p><strong>Why:</strong> Ensures all core components have a consistent way to be
initialized and shut down by the main <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> class.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">Factory[T]</span></code> (Generic Abstract Base Class - ABC):</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Defines the basic contract for all factory classes. The
<code class="docutils literal notranslate"><span class="pre">[T]</span></code> makes it generic, meaning you specify the <em>type</em> of object the
factory creates (e.g., <code class="docutils literal notranslate"><span class="pre">Factory[SpanExporter]</span></code>).</p></li>
<li><p><strong>Methods:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">create()</span> <span class="pre">-&gt;</span> <span class="pre">T</span></code>: An abstract method that each factory <em>must</em>
implement. This method contains the logic to instantiate and return
an object of type <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Why:</strong> Enforces that all factories have a standard <code class="docutils literal notranslate"><span class="pre">create()</span></code> method,
making them interchangeable from the perspective of the code that uses
them.</p></li>
</ul>
</li>
</ul>
</section>
<section id="defining-constants-enums-constants-py">
<h3>3.6 Defining Constants: Enums (<code class="docutils literal notranslate"><span class="pre">constants.py</span></code>)<a class="headerlink" href="#defining-constants-enums-constants-py" title="Link to this heading">#</a></h3>
<p>This module uses Python’s <code class="docutils literal notranslate"><span class="pre">enum.StrEnum</span></code> to define sets of named constants.</p>
<ul class="simple">
<li><p><strong>Purpose:</strong> To provide clear, readable, and type-safe names for
configuration options instead of using raw strings.</p></li>
<li><p><strong>Examples:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">EnvironmentType</span></code>: Defines valid environment names (<code class="docutils literal notranslate"><span class="pre">DEVELOPMENT</span></code>,
<code class="docutils literal notranslate"><span class="pre">STAGING</span></code>, <code class="docutils literal notranslate"><span class="pre">PRODUCTION</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ExporterType</span></code>: Defines valid exporter types (<code class="docutils literal notranslate"><span class="pre">CONSOLE</span></code>, <code class="docutils literal notranslate"><span class="pre">OTLP</span></code>,
<code class="docutils literal notranslate"><span class="pre">IN_MEMORY</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ProcessorType</span></code>: Defines valid processor types (<code class="docutils literal notranslate"><span class="pre">BATCH</span></code>, <code class="docutils literal notranslate"><span class="pre">SIMPLE</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PropagatorType</span></code>: Defines valid context propagators (<code class="docutils literal notranslate"><span class="pre">TRACECONTEXT</span></code>,
<code class="docutils literal notranslate"><span class="pre">BAGGAGE</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SamplingStrategy</span></code>: Defines valid tracing sampling strategies.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LogLevel</span></code>: Defines standard logging levels.</p></li>
</ul>
</li>
<li><p><strong>Why use Enums?</strong></p>
<ul>
<li><p><strong>Readability:</strong> <code class="docutils literal notranslate"><span class="pre">ExporterType.OTLP</span></code> is clearer than <code class="docutils literal notranslate"><span class="pre">&quot;otlp&quot;</span></code>.</p></li>
<li><p><strong>Type Safety:</strong> Prevents typos. Using an incorrect string might pass
silently, but using an undefined Enum member will raise an error.</p></li>
<li><p><strong>Discoverability:</strong> IDEs can easily show available options.</p></li>
<li><p><strong>Maintainability:</strong> If options change, you only need to update the Enum
definition.</p></li>
</ul>
</li>
</ul>
</section>
<section id="representing-your-service-resource-resource-py">
<h3>3.7 Representing Your Service: <code class="docutils literal notranslate"><span class="pre">Resource</span></code> (<code class="docutils literal notranslate"><span class="pre">resource.py</span></code>)<a class="headerlink" href="#representing-your-service-resource-resource-py" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ResourceFactory</span></code>:</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Creates an OpenTelemetry <code class="docutils literal notranslate"><span class="pre">Resource</span></code> object.</p></li>
<li><p><strong>What is a Resource?</strong> A <code class="docutils literal notranslate"><span class="pre">Resource</span></code> is a collection of key-value pairs
(attributes) that identify the entity producing telemetry data (i.e.,
your application or service). These attributes are attached to <em>all</em>
telemetry (traces, metrics, logs) originating from that entity.</p></li>
<li><p><strong>Standard Attributes:</strong> Common attributes include:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">service.name</span></code>: The logical name of your service (e.g., <code class="docutils literal notranslate"><span class="pre">user-api</span></code>,
<code class="docutils literal notranslate"><span class="pre">billing-service</span></code>). <strong>Crucial for filtering/grouping in backends.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">service.version</span></code>: The version of your service (e.g., <code class="docutils literal notranslate"><span class="pre">1.2.3</span></code>,
<code class="docutils literal notranslate"><span class="pre">git-commit-hash</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment.environment</span></code>: The environment where the service is
running (e.g., <code class="docutils literal notranslate"><span class="pre">development</span></code>, <code class="docutils literal notranslate"><span class="pre">production</span></code>).</p></li>
</ul>
</li>
<li><p><strong>Creation:</strong> The factory takes service name, version, environment, and
any additional custom attributes from <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> and uses
<code class="docutils literal notranslate"><span class="pre">Resource.create(...)</span></code> to build the object.</p></li>
</ul>
</li>
</ul>
</section>
<section id="handling-traces-tracingcomponent-trace-py">
<h3>3.8 Handling Traces: <code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">trace.py</span></code>)<a class="headerlink" href="#handling-traces-tracingcomponent-trace-py" title="Link to this heading">#</a></h3>
<p>This module sets up the entire pipeline for distributed tracing.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">SpanExporterFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">SpanExporter</span></code> instances (Console, OTLP,
In-Memory) based on <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code>. The OTLP exporter sends trace data to
the Collector.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">SpanProcessorFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">SpanProcessor</span></code> instances (Batch,
Simple) based on <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code>.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">BatchSpanProcessor</span></code>: Collects spans in a queue and exports them in
batches periodically or when the queue is full. <strong>Recommended for
production</strong> for efficiency. Configured via <code class="docutils literal notranslate"><span class="pre">max_queue_size</span></code>,
<code class="docutils literal notranslate"><span class="pre">schedule_delay_millis</span></code>, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SimpleSpanProcessor</span></code>: Exports each span immediately as it ends. Easier
for debugging but less efficient.</p></li>
<li><p>The processor uses the exporter created by <code class="docutils literal notranslate"><span class="pre">SpanExporterFactory</span></code> to
actually send the data.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code>:</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Orchestrates the setup of the tracing pipeline using the
factories and settings.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">setup()</span></code> Method:</strong></p>
<ol class="arabic simple">
<li><p>Creates a <code class="docutils literal notranslate"><span class="pre">Sampler</span></code> (using <code class="docutils literal notranslate"><span class="pre">SamplerFactory</span></code> from <code class="docutils literal notranslate"><span class="pre">sampler.py</span></code>) to
decide which requests should be traced.</p></li>
<li><p>Creates a <code class="docutils literal notranslate"><span class="pre">SpanProcessor</span></code> (using <code class="docutils literal notranslate"><span class="pre">SpanProcessorFactory</span></code>).</p></li>
<li><p>Creates an OTel <code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code>, configuring it with the
<code class="docutils literal notranslate"><span class="pre">Resource</span></code>, <code class="docutils literal notranslate"><span class="pre">Sampler</span></code>, and <code class="docutils literal notranslate"><span class="pre">SpanProcessor</span></code>. The <code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code> is
the main entry point for the OTel tracing SDK.</p></li>
<li><p>Sets the created <code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code> as the <strong>global</strong> provider using
<code class="docutils literal notranslate"><span class="pre">trace.set_tracer_provider(...)</span></code>. This makes it available throughout
your application.</p></li>
<li><p>Gets a <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> instance from the global provider using
<code class="docutils literal notranslate"><span class="pre">trace.get_tracer(...)</span></code>. This <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> object is what’s actually
used to create spans (via <code class="docutils literal notranslate"><span class="pre">telemetry.tracer</span></code>).</p></li>
</ol>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> Method:</strong> Calls <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> on the <code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code>,
which in turn shuts down the processor and exporter, ensuring buffered
spans are flushed.</p></li>
</ul>
</li>
</ul>
</section>
<section id="handling-metrics-metricscomponent-metric-py">
<h3>3.9 Handling Metrics: <code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">metric.py</span></code>)<a class="headerlink" href="#handling-metrics-metricscomponent-metric-py" title="Link to this heading">#</a></h3>
<p>This module sets up the pipeline for collecting and exporting metrics.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">MetricExporterFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">MetricExporter</span></code> instances (Console,
OTLP) based on <code class="docutils literal notranslate"><span class="pre">MetricsConfig</span></code>. The OTLP exporter sends metrics data to the
Collector.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">MetricReaderFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">MetricReader</span></code> instances. The primary one
used here is:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">PeriodicExportingMetricReader</span></code>: Collects aggregated metric data at
regular intervals (defined by <code class="docutils literal notranslate"><span class="pre">export_interval_millis</span></code>) and sends it to
the configured <code class="docutils literal notranslate"><span class="pre">MetricExporter</span></code>. This is the standard way to export
metrics in OTel.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code>:</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Orchestrates the setup of the metrics pipeline.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">setup()</span></code> Method:</strong></p>
<ol class="arabic simple">
<li><p>Creates a <code class="docutils literal notranslate"><span class="pre">MetricReader</span></code> (using <code class="docutils literal notranslate"><span class="pre">MetricReaderFactory</span></code>).</p></li>
<li><p>Creates an OTel <code class="docutils literal notranslate"><span class="pre">MeterProvider</span></code>, configuring it with the <code class="docutils literal notranslate"><span class="pre">Resource</span></code>
and the <code class="docutils literal notranslate"><span class="pre">MetricReader</span></code>. The <code class="docutils literal notranslate"><span class="pre">MeterProvider</span></code> manages meters and the
export process.</p></li>
<li><p>Sets the created <code class="docutils literal notranslate"><span class="pre">MeterProvider</span></code> as the <strong>global</strong> provider using
<code class="docutils literal notranslate"><span class="pre">metrics.set_meter_provider(...)</span></code>.</p></li>
<li><p>Gets a <code class="docutils literal notranslate"><span class="pre">Meter</span></code> instance from the global provider using
<code class="docutils literal notranslate"><span class="pre">metrics.get_meter(...)</span></code>. This <code class="docutils literal notranslate"><span class="pre">Meter</span></code> object is what’s actually
used to create metric instruments like counters and histograms (via
<code class="docutils literal notranslate"><span class="pre">telemetry.meter</span></code>).</p></li>
</ol>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> Method:</strong> Calls <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> on the <code class="docutils literal notranslate"><span class="pre">MeterProvider</span></code>,
ensuring a final export of metrics occurs.</p></li>
</ul>
</li>
</ul>
</section>
<section id="handling-logs-loggingcomponent-log-py">
<h3>3.10 Handling Logs: <code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">log.py</span></code>)<a class="headerlink" href="#handling-logs-loggingcomponent-log-py" title="Link to this heading">#</a></h3>
<p>This module sets up the pipeline for exporting structured logs enriched with
trace context.</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">LogExporterFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">LogExporter</span></code> instances (Console, OTLP)
based on <code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code>. The OTLP exporter sends log data to the Collector.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">LogProcessorFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">LogRecordProcessor</span></code> instances (Batch,
Simple) based on <code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BatchLogRecordProcessor</span></code>: Collects log records and exports them in
batches. Configured via <code class="docutils literal notranslate"><span class="pre">max_queue_size</span></code>, <code class="docutils literal notranslate"><span class="pre">schedule_delay_millis</span></code>, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SimpleLogRecordProcessor</span></code>: Exports each log record immediately.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code>:</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Configures Python’s standard <code class="docutils literal notranslate"><span class="pre">logging</span></code> module to integrate
with OpenTelemetry.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">setup()</span></code> Method:</strong></p>
<ol class="arabic simple">
<li><p>Creates a <code class="docutils literal notranslate"><span class="pre">LogRecordProcessor</span></code> (using <code class="docutils literal notranslate"><span class="pre">LogProcessorFactory</span></code>).</p></li>
<li><p>Creates an OTel <code class="docutils literal notranslate"><span class="pre">LoggerProvider</span></code>, configuring it with the <code class="docutils literal notranslate"><span class="pre">Resource</span></code>
and the <code class="docutils literal notranslate"><span class="pre">LogRecordProcessor</span></code>.</p></li>
<li><p>Sets the created <code class="docutils literal notranslate"><span class="pre">LoggerProvider</span></code> as the provider for OTel logging
using <code class="docutils literal notranslate"><span class="pre">set_logger_provider(...)</span></code>.</p></li>
<li><p>Uses <code class="docutils literal notranslate"><span class="pre">LoggingInstrumentor().instrument(...)</span></code>: This is the key step.
It modifies the standard Python <code class="docutils literal notranslate"><span class="pre">logging</span></code> system:</p>
<ul class="simple">
<li><p>It automatically injects the current <code class="docutils literal notranslate"><span class="pre">trace_id</span></code> and <code class="docutils literal notranslate"><span class="pre">span_id</span></code>
from the active trace context into log records.</p></li>
<li><p>It can optionally set a logging format that includes these IDs.</p></li>
</ul>
</li>
<li><p>Gets a standard Python <code class="docutils literal notranslate"><span class="pre">Logger</span></code> instance (<code class="docutils literal notranslate"><span class="pre">logging.getLogger(...)</span></code>)
which is now “trace-aware”. This logger is exposed via
<code class="docutils literal notranslate"><span class="pre">telemetry.logger</span></code>.</p></li>
</ol>
<ul class="simple">
<li><p><em>Development Enhancement:</em> If the environment is <code class="docutils literal notranslate"><span class="pre">DEVELOPMENT</span></code> and
the primary exporter isn’t already Console, it adds an <em>additional</em>
<code class="docutils literal notranslate"><span class="pre">SimpleLogRecordProcessor</span></code> with a <code class="docutils literal notranslate"><span class="pre">ConsoleLogExporter</span></code> to ensure
logs are always visible on the console during development.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> Method:</strong> Calls <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> on the <code class="docutils literal notranslate"><span class="pre">LoggerProvider</span></code> and
processors, and uninstruments the logging system.</p></li>
</ul>
</li>
</ul>
</section>
<section id="handling-context-propagation-propagatorcomponent-propagator-py">
<h3>3.11 Handling Context Propagation: <code class="docutils literal notranslate"><span class="pre">PropagatorComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">propagator.py</span></code>)<a class="headerlink" href="#handling-context-propagation-propagatorcomponent-propagator-py" title="Link to this heading">#</a></h3>
<p>This module configures how trace context is shared between services.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">PropagatorFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">TextMapPropagator</span></code> instances based on
<code class="docutils literal notranslate"><span class="pre">PropagationConfig</span></code>.</p>
<ul>
<li><p><strong>What is a Propagator?</strong> An object that knows how to inject (serialize)
trace context into and extract (deserialize) trace context from a
“carrier” (usually HTTP headers).</p></li>
<li><p><strong>Supported Types (from <code class="docutils literal notranslate"><span class="pre">constants.PropagatorType</span></code>):</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">TRACECONTEXT</span></code>: Implements the standard W3C TraceContext
specification (uses <code class="docutils literal notranslate"><span class="pre">traceparent</span></code> and <code class="docutils literal notranslate"><span class="pre">tracestate</span></code> headers). <strong>This
is the recommended standard.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BAGGAGE</span></code>: Implements the W3C Baggage specification (uses <code class="docutils literal notranslate"><span class="pre">baggage</span></code>
header). Baggage allows propagating arbitrary key-value pairs along
with the trace context.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">CompositePropagator</span></code>:</strong> The factory typically creates a
<code class="docutils literal notranslate"><span class="pre">CompositePropagator</span></code> that combines multiple individual propagators
(e.g., both <code class="docutils literal notranslate"><span class="pre">TraceContextTextMapPropagator</span></code> and <code class="docutils literal notranslate"><span class="pre">W3CBaggagePropagator</span></code>
by default). This allows compatibility with different systems.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">PropagatorComponent</span></code>:</strong></p>
<ul>
<li><p><strong>Purpose:</strong> Manages the propagator lifecycle.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">setup()</span></code> Method:</strong></p>
<ol class="arabic simple">
<li><p>Creates the configured <code class="docutils literal notranslate"><span class="pre">TextMapPropagator</span></code> using the factory.</p></li>
<li><p>Sets the created propagator as the <strong>global</strong> propagator using
<code class="docutils literal notranslate"><span class="pre">opentelemetry.propagate.set_global_textmap(...)</span></code>. This makes it
available for automatic instrumentation (like in web frameworks) and
manual injection/extraction via <code class="docutils literal notranslate"><span class="pre">telemetry.propagator</span></code>.</p></li>
</ol>
</li>
</ul>
</li>
</ul>
</section>
<section id="controlling-trace-volume-sampler-sampler-py">
<h3>3.12 Controlling Trace Volume: <code class="docutils literal notranslate"><span class="pre">Sampler</span></code> (<code class="docutils literal notranslate"><span class="pre">sampler.py</span></code>)<a class="headerlink" href="#controlling-trace-volume-sampler-sampler-py" title="Link to this heading">#</a></h3>
<p>This module configures the tracing sampler.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">SamplerFactory</span></code>:</strong> Creates <code class="docutils literal notranslate"><span class="pre">Sampler</span></code> instances based on <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code>.</p>
<ul>
<li><p><strong>What is a Sampler?</strong> An object that decides whether a given trace
should be recorded and exported (“sampled”) or ignored (“dropped”).
Sampling is crucial for managing the volume of trace data and reducing
overhead in high-traffic systems.</p></li>
<li><p><strong>Sampling Decision:</strong> The decision is made when a <em>new trace</em> is
started (i.e., when the first span in a trace, the “root span,” is
created). The decision (sample or drop) is then propagated to downstream
services via the trace context.</p></li>
<li><p><strong>Supported Strategies (from <code class="docutils literal notranslate"><span class="pre">constants.SamplingStrategy</span></code>):</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ALWAYS_ON</span></code>: Samples every single trace. Useful for development or
low-traffic environments.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ALWAYS_OFF</span></code>: Samples no traces. Useful for temporarily disabling
tracing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PARENT_BASED_ALWAYS_ON</span></code>: <strong>Default strategy.</strong> Respects the
sampling decision of the parent span (if one exists via propagated
context). If there’s no parent, it <em>always</em> samples. This ensures
that if a trace was started upstream, the current service continues
it, but new traces started in this service are always sampled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PARENT_BASED_ALWAYS_OFF</span></code>: Respects the parent’s decision. If no
parent, it <em>never</em> samples. Useful if you only want traces initiated
by specific entry points.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TRACE_ID_RATIO</span></code>: Samples a fraction of traces based on the trace
ID. For example, <code class="docutils literal notranslate"><span class="pre">sample_rate=0.1</span></code> samples approximately 10% of
traces. This is a common strategy for production to control volume.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Role in <code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code>:</strong> The <code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code> uses this factory to
create the sampler instance, which is then passed to the <code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code>
during setup.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="configuration-in-detail-settings-py">
<h2>4. Configuration In Detail (<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>)<a class="headerlink" href="#configuration-in-detail-settings-py" title="Link to this heading">#</a></h2>
<p>This library uses Pydantic for configuration, primarily loaded from environment
variables.</p>
<section id="loading-configuration">
<h3>4.1 Loading Configuration<a class="headerlink" href="#loading-configuration" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Environment Variables:</strong> Settings are loaded from environment variables.
Nested settings use <code class="docutils literal notranslate"><span class="pre">__</span></code> (double underscore) as a separator. For example, to
set the tracing exporter type, you would set the environment variable
<code class="docutils literal notranslate"><span class="pre">TRACING__EXPORTER_TYPE=otlp</span></code>.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">.env</span></code> Files:</strong> The demo application uses <code class="docutils literal notranslate"><span class="pre">python-dotenv</span></code> to load
environment variables from a <code class="docutils literal notranslate"><span class="pre">.env.local</span></code> file, which is a common practice
for development.</p></li>
<li><p><strong>Pydantic <code class="docutils literal notranslate"><span class="pre">BaseSettings</span></code>:</strong> The <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> class inherits from
<code class="docutils literal notranslate"><span class="pre">BaseSettings</span></code>, which handles the automatic loading and validation.</p></li>
<li><p><strong>Defaults:</strong> If an environment variable is not set, the default value
specified in the Pydantic model is used.</p></li>
<li><p><strong>Immutability:</strong> Settings objects are “frozen” (<code class="docutils literal notranslate"><span class="pre">frozen=True</span></code>), meaning
they cannot be changed after creation.</p></li>
</ul>
</section>
<section id="main-telemetrysettings">
<h3>4.2 Main <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code><a class="headerlink" href="#main-telemetrysettings" title="Link to this heading">#</a></h3>
<p>This is the top-level container for all settings.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">service:</span> <span class="pre">ServiceInfo</span></code>: Defines information about the service being
instrumented. (See below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">schema_url:</span> <span class="pre">str</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>) Specifies the OpenTelemetry Schema URL.
This URL identifies the version of the OpenTelemetry Semantic Conventions
the telemetry data adheres to. Useful for ensuring compatibility and
understanding across different tools.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">excluded_paths:</span> <span class="pre">list[str]</span></code>: (Default:
<code class="docutils literal notranslate"><span class="pre">[&quot;/health&quot;,</span> <span class="pre">&quot;/metrics&quot;,</span> <span class="pre">&quot;/favicon.ico&quot;]</span></code>) A list of URL paths that should
be excluded from automatic tracing (e.g., by web framework instrumentation).
Useful for ignoring noisy endpoints like health checks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">propagation:</span> <span class="pre">PropagationConfig</span></code>: Configuration for context propagation.
(See below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tracing:</span> <span class="pre">TracingConfig</span></code>: Configuration for distributed tracing. (See below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metrics:</span> <span class="pre">MetricsConfig</span></code>: Configuration for metrics. (See below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logging:</span> <span class="pre">LoggingConfig</span></code>: Configuration for logging. (See below)</p></li>
</ul>
</section>
<section id="serviceinfo">
<h3>4.3 <code class="docutils literal notranslate"><span class="pre">ServiceInfo</span></code><a class="headerlink" href="#serviceinfo" title="Link to this heading">#</a></h3>
<p>Identifies the application producing telemetry. These become <code class="docutils literal notranslate"><span class="pre">Resource</span></code>
attributes.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name:</span> <span class="pre">str</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">&quot;unknown-service&quot;</span></code>) The logical name of your service
(e.g., <code class="docutils literal notranslate"><span class="pre">user-api</span></code>). <strong>Required.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">version:</span> <span class="pre">str</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">&quot;0.1.0&quot;</span></code>) The version of your service.
<strong>Required.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">environment:</span> <span class="pre">EnvironmentType</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">EnvironmentType.DEVELOPMENT</span></code>) The
deployment environment (<code class="docutils literal notranslate"><span class="pre">development</span></code>, <code class="docutils literal notranslate"><span class="pre">staging</span></code>, or <code class="docutils literal notranslate"><span class="pre">production</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">additional_attributes:</span> <span class="pre">dict[str,</span> <span class="pre">Any]</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">{}</span></code>) A dictionary for
any other custom attributes you want to attach to the resource (e.g.,
<code class="docutils literal notranslate"><span class="pre">{&quot;region&quot;:</span> <span class="pre">&quot;us-east-1&quot;,</span> <span class="pre">&quot;k8s.pod.name&quot;:</span> <span class="pre">&quot;my-pod-xyz&quot;}</span></code>).</p></li>
</ul>
</section>
<section id="collectorendpoint">
<h3>4.4 <code class="docutils literal notranslate"><span class="pre">CollectorEndpoint</span></code><a class="headerlink" href="#collectorendpoint" title="Link to this heading">#</a></h3>
<p>Defines connection details for an OpenTelemetry Collector. Used within
<code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricsConfig</span></code>, and <code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">host:</span> <span class="pre">str</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">&quot;localhost&quot;</span></code>) Hostname or IP address of the OTel
Collector.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">port:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">4317</span></code>) Port number the Collector is listening on.
<strong>Note:</strong> 4317 is the default for OTLP/gRPC, while 4318 is the default for
OTLP/HTTP. Ensure this matches the receiver configuration in your Collector.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">protocol:</span> <span class="pre">Literal[&quot;http&quot;,</span> <span class="pre">&quot;https&quot;]</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code>) Protocol to use.
<strong>Important:</strong> Even for gRPC connections, OpenTelemetry SDKs often expect
the base URL scheme, so <code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code> is typically correct unless you have TLS
configured <em>between the application and the collector</em> (which is separate
from TLS between the collector and backends).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">url:</span> <span class="pre">str</span></code> (Computed Field): Automatically generates the full URL string
like <code class="docutils literal notranslate"><span class="pre">http://localhost:4317</span></code>.</p></li>
</ul>
</section>
<section id="exportconfig">
<h3>4.5 <code class="docutils literal notranslate"><span class="pre">ExportConfig</span></code><a class="headerlink" href="#exportconfig" title="Link to this heading">#</a></h3>
<p>Common settings for batch exporting behavior. Used within <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code> and
<code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">512</span></code>) Maximum number of telemetry items (spans
or logs) to include in a single export batch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">schedule_delay_millis:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">5000</span></code>) Maximum time (in
milliseconds) to wait before exporting an incomplete batch. A batch will be
sent either when it’s full (<code class="docutils literal notranslate"><span class="pre">batch_size</span></code>) or when this timer expires,
whichever comes first.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timeout_millis:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">30000</span></code>) Maximum time (in milliseconds) to
wait for an export request to complete before timing out.</p></li>
</ul>
</section>
<section id="propagationconfig">
<h3>4.6 <code class="docutils literal notranslate"><span class="pre">PropagationConfig</span></code><a class="headerlink" href="#propagationconfig" title="Link to this heading">#</a></h3>
<p>Settings for context propagation.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enabled:</span> <span class="pre">bool</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">True</span></code>) Whether context propagation is enabled
globally.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">propagator_types:</span> <span class="pre">list[PropagatorType]</span></code>: (Default:
<code class="docutils literal notranslate"><span class="pre">[TRACECONTEXT,</span> <span class="pre">BAGGAGE]</span></code>) List of propagator types to use. The
<code class="docutils literal notranslate"><span class="pre">CompositePropagator</span></code> will be configured to use all specified types.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">TRACECONTEXT</span></code>: W3C Trace Context standard (uses <code class="docutils literal notranslate"><span class="pre">traceparent</span></code>,
<code class="docutils literal notranslate"><span class="pre">tracestate</span></code> headers). <strong>Recommended.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BAGGAGE</span></code>: W3C Baggage standard (uses <code class="docutils literal notranslate"><span class="pre">baggage</span></code> header). Allows passing
key-value pairs across service boundaries.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COMPOSITE</span></code>: This is used internally when multiple types are selected,
not usually specified directly here.</p></li>
</ul>
</li>
</ul>
</section>
<section id="tracingconfig">
<h3>4.7 <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code><a class="headerlink" href="#tracingconfig" title="Link to this heading">#</a></h3>
<p>Settings specific to distributed tracing.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enabled:</span> <span class="pre">bool</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">True</span></code>) Whether tracing is enabled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exporter_type:</span> <span class="pre">ExporterType</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">CONSOLE</span></code>) Type of exporter to use
for spans (<code class="docutils literal notranslate"><span class="pre">CONSOLE</span></code>, <code class="docutils literal notranslate"><span class="pre">OTLP</span></code>, <code class="docutils literal notranslate"><span class="pre">IN_MEMORY</span></code>). Set to <code class="docutils literal notranslate"><span class="pre">OTLP</span></code> to send to the
Collector.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collector:</span> <span class="pre">CollectorEndpoint</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">host=&quot;localhost&quot;,</span> <span class="pre">port=4317</span></code>)
Endpoint configuration if <code class="docutils literal notranslate"><span class="pre">exporter_type</span></code> is <code class="docutils literal notranslate"><span class="pre">OTLP</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">processor_type:</span> <span class="pre">ProcessorType</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">BATCH</span></code>) Type of span processor
(<code class="docutils literal notranslate"><span class="pre">BATCH</span></code>, <code class="docutils literal notranslate"><span class="pre">SIMPLE</span></code>). <code class="docutils literal notranslate"><span class="pre">BATCH</span></code> is recommended for performance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sampling_strategy:</span> <span class="pre">SamplingStrategy</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">PARENT_BASED_ALWAYS_ON</span></code>)
How to decide which traces to sample. See Section 3.12 for details.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sample_rate:</span> <span class="pre">float</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">1.0</span></code>) Sampling rate (between 0.0 and 1.0)
used only if <code class="docutils literal notranslate"><span class="pre">sampling_strategy</span></code> is <code class="docutils literal notranslate"><span class="pre">TRACE_ID_RATIO</span></code>. <code class="docutils literal notranslate"><span class="pre">1.0</span></code> means sample
everything, <code class="docutils literal notranslate"><span class="pre">0.1</span></code> means sample 10%.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">export_config:</span> <span class="pre">ExportConfig</span></code>: Batching and timeout settings for the span
processor/exporter.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">additional_exporter_args:</span> <span class="pre">dict[str,</span> <span class="pre">Any]</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">{}</span></code>) Extra keyword
arguments to pass directly to the chosen span exporter’s constructor (e.g.,
for specific TLS settings if needed, though often handled via endpoint URL).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">additional_processor_args:</span> <span class="pre">dict[str,</span> <span class="pre">Any]</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">{}</span></code>) Extra keyword
arguments to pass directly to the chosen span processor’s constructor.</p></li>
</ul>
</section>
<section id="metricsconfig">
<h3>4.8 <code class="docutils literal notranslate"><span class="pre">MetricsConfig</span></code><a class="headerlink" href="#metricsconfig" title="Link to this heading">#</a></h3>
<p>Settings specific to metrics.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enabled:</span> <span class="pre">bool</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">True</span></code>) Whether metrics collection is enabled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exporter_type:</span> <span class="pre">ExporterType</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">CONSOLE</span></code>) Type of exporter for
metrics (<code class="docutils literal notranslate"><span class="pre">CONSOLE</span></code>, <code class="docutils literal notranslate"><span class="pre">OTLP</span></code>). Set to <code class="docutils literal notranslate"><span class="pre">OTLP</span></code> to send to the Collector.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collector:</span> <span class="pre">CollectorEndpoint</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">host=&quot;localhost&quot;,</span> <span class="pre">port=4317</span></code>)
Endpoint configuration if <code class="docutils literal notranslate"><span class="pre">exporter_type</span></code> is <code class="docutils literal notranslate"><span class="pre">OTLP</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">export_interval_millis:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">60000</span></code>) How often (in
milliseconds) the <code class="docutils literal notranslate"><span class="pre">PeriodicExportingMetricReader</span></code> should collect and export
metrics.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">export_timeout_millis:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">30000</span></code>) Maximum time (in
milliseconds) to wait for a metric export operation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">additional_exporter_args:</span> <span class="pre">dict[str,</span> <span class="pre">Any]</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">{}</span></code>) Extra keyword
arguments for the metric exporter constructor.</p></li>
</ul>
</section>
<section id="loggingconfig">
<h3>4.9 <code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code><a class="headerlink" href="#loggingconfig" title="Link to this heading">#</a></h3>
<p>Settings specific to logging.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enabled:</span> <span class="pre">bool</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">True</span></code>) Whether OTel log handling is enabled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">processor_type:</span> <span class="pre">ProcessorType</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">SIMPLE</span></code>) Type of log processor
(<code class="docutils literal notranslate"><span class="pre">BATCH</span></code>, <code class="docutils literal notranslate"><span class="pre">SIMPLE</span></code>). <code class="docutils literal notranslate"><span class="pre">SIMPLE</span></code> is often fine for logs unless volume is very
high, but <code class="docutils literal notranslate"><span class="pre">BATCH</span></code> can be more efficient.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exporter_type:</span> <span class="pre">ExporterType</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">CONSOLE</span></code>) Type of exporter for
logs (<code class="docutils literal notranslate"><span class="pre">CONSOLE</span></code>, <code class="docutils literal notranslate"><span class="pre">OTLP</span></code>). Set to <code class="docutils literal notranslate"><span class="pre">OTLP</span></code> to send to the Collector.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collector:</span> <span class="pre">CollectorEndpoint</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">host=&quot;localhost&quot;,</span> <span class="pre">port=4317</span></code>)
Endpoint configuration if <code class="docutils literal notranslate"><span class="pre">exporter_type</span></code> is <code class="docutils literal notranslate"><span class="pre">OTLP</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">level:</span> <span class="pre">LogLevel</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">INFO</span></code>) The <em>minimum</em> log level that the
configured logger will process (e.g., <code class="docutils literal notranslate"><span class="pre">INFO</span></code> means <code class="docutils literal notranslate"><span class="pre">INFO</span></code>, <code class="docutils literal notranslate"><span class="pre">WARNING</span></code>,
<code class="docutils literal notranslate"><span class="pre">ERROR</span></code>, <code class="docutils literal notranslate"><span class="pre">CRITICAL</span></code> logs will be processed, but <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> logs will be
ignored). This applies to the logger obtained via <code class="docutils literal notranslate"><span class="pre">telemetry.logger</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">export_config:</span> <span class="pre">ExportConfig</span></code>: Default batching/timeout settings (can be
overridden by specific settings below).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">schedule_delay_millis:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">5000</span></code>) Specific schedule delay for
the <code class="docutils literal notranslate"><span class="pre">BatchLogRecordProcessor</span></code>. Overrides <code class="docutils literal notranslate"><span class="pre">export_config</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_export_batch_size:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">512</span></code>) Specific batch size for the
<code class="docutils literal notranslate"><span class="pre">BatchLogRecordProcessor</span></code>. Overrides <code class="docutils literal notranslate"><span class="pre">export_config</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">export_timeout_millis:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">30000</span></code>) Specific timeout for log
export. Overrides <code class="docutils literal notranslate"><span class="pre">export_config</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_queue_size:</span> <span class="pre">int</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">512</span></code>) Maximum number of log records to
buffer in the <code class="docutils literal notranslate"><span class="pre">BatchLogRecordProcessor</span></code>’s queue before potentially dropping
logs if the exporter is slow.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">additional_processor_args:</span> <span class="pre">dict[str,</span> <span class="pre">Any]</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">{}</span></code>) Extra keyword
arguments for the log processor constructor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">additional_exporter_args:</span> <span class="pre">dict[str,</span> <span class="pre">Any]</span></code>: (Default: <code class="docutils literal notranslate"><span class="pre">{}</span></code>) Extra keyword
arguments for the log exporter constructor.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="how-to-use-cryostorm-examples">
<h2>5. How to Use <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> (Examples)<a class="headerlink" href="#how-to-use-cryostorm-examples" title="Link to this heading">#</a></h2>
<p>Here are basic examples showing how to use the <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> facade in your
application code.</p>
<section id="initialization">
<h3>5.1 Initialization<a class="headerlink" href="#initialization" title="Link to this heading">#</a></h3>
<p>Typically done once when your application starts.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">instrumentation.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelemetrySettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">instrumentation.telemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">Telemetry</span>

<span class="c1"># --- 1. Load Configuration ---</span>
<span class="c1"># Load environment variables from a .env file (optional, good for development)</span>
<span class="c1"># Assumes .env.local is two directories up from the current file</span>
<span class="c1"># dotenv_path = Path(__file__).parents[1] / &quot;.env.local&quot;</span>
<span class="c1"># load_dotenv(override=False, dotenv_path=dotenv_path) # Set override=True to overwrite existing env vars</span>

<span class="c1"># Create the settings object - Pydantic loads from env vars automatically</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">TelemetrySettings</span><span class="p">(</span>
        <span class="c1"># You can override specific settings programmatically if needed,</span>
        <span class="c1"># but usually rely on environment variables.</span>
        <span class="c1"># Example: service=ServiceInfo(name=&quot;my-cool-app&quot;, version=&quot;1.0&quot;)</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telemetry Settings Loaded:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># Pretty print the loaded settings</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading Telemetry Settings: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Handle error appropriately, maybe exit or use default non-functional telemetry</span>

<span class="c1"># --- 2. Initialize Telemetry ---</span>
<span class="c1"># Create the singleton Telemetry instance using the loaded settings</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">telemetry</span> <span class="o">=</span> <span class="n">Telemetry</span><span class="o">.</span><span class="n">from_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telemetry initialized successfully.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FATAL: Failed to initialize telemetry: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Application might not function correctly without telemetry, decide how to handle this.</span>
    <span class="c1"># You could potentially fall back to basic logging.</span>
    <span class="c1"># For this example, we&#39;ll re-raise after logging.</span>
    <span class="k">raise</span>

<span class="c1"># --- Application Lifecycle ---</span>
<span class="c1"># Your application code runs here...</span>

<span class="c1"># --- 3. Shutdown (Crucial!) ---</span>
<span class="c1"># Ensure shutdown is called before the application exits to flush buffered data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shutdown_app</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shutting down application...&quot;</span><span class="p">)</span>
    <span class="n">telemetry</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telemetry shut down complete.&quot;</span><span class="p">)</span>

<span class="c1"># Example: Register shutdown hook (e.g., using atexit or framework signals)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">atexit</span>
<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">shutdown_app</span><span class="p">)</span>

<span class="c1"># Keep the example running briefly to simulate an application lifetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Application running...&quot;</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Application exiting...&quot;</span><span class="p">)</span>

<span class="c1"># Note: In a real app (like FastAPI), initialization happens during startup lifespan,</span>
<span class="c1"># and shutdown happens during shutdown lifespan.</span>
</pre></div>
</div>
<p><strong>Explanation:</strong></p>
<ol class="arabic simple">
<li><p><strong>Load Configuration:</strong> We first load environment variables (optionally from
a <code class="docutils literal notranslate"><span class="pre">.env</span></code> file) and then create a <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> object. Pydantic
validates the settings.</p></li>
<li><p><strong>Initialize Telemetry:</strong> We pass the <code class="docutils literal notranslate"><span class="pre">settings</span></code> object to
<code class="docutils literal notranslate"><span class="pre">Telemetry.from_settings()</span></code>. This creates the singleton instance and runs
the internal <code class="docutils literal notranslate"><span class="pre">setup_all()</span></code> logic, configuring OTel.</p></li>
<li><p><strong>Shutdown:</strong> We define a <code class="docutils literal notranslate"><span class="pre">shutdown_app</span></code> function that calls
<code class="docutils literal notranslate"><span class="pre">telemetry.shutdown()</span></code>. This is registered using <code class="docutils literal notranslate"><span class="pre">atexit</span></code> to ensure it’s
called when the script exits normally. <strong>This step is vital</strong> to ensure
telemetry data buffered in memory (e.g., by batch processors) is sent before
the application terminates.</p></li>
</ol>
</section>
<section id="creating-traces-spans">
<h3>5.2 Creating Traces (Spans)<a class="headerlink" href="#creating-traces-spans" title="Link to this heading">#</a></h3>
<p>Traces track the flow of a request. Each unit of work within a trace is a
“Span”.</p>
<p><strong>Method 1: Using the <code class="docutils literal notranslate"><span class="pre">traced</span></code> decorator (Easiest)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming &#39;telemetry&#39; instance is initialized as shown above</span>

<span class="nd">@telemetry</span><span class="o">.</span><span class="n">traced</span><span class="p">(</span><span class="n">span_name</span><span class="o">=</span><span class="s2">&quot;my_custom_function_span&quot;</span><span class="p">)</span> <span class="c1"># Customize span name</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Simulate work</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;input_keys&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing complete.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="nd">@telemetry</span><span class="o">.</span><span class="n">traced</span> <span class="c1"># Default span name will be &#39;module.function_name&#39;</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_task</span><span class="p">(</span><span class="n">item_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting async task for item </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Add attributes to the current span automatically created by the decorator</span>
    <span class="n">current_span</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">()</span>
    <span class="n">current_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;item.id&quot;</span><span class="p">,</span> <span class="n">item_id</span><span class="p">)</span>
    <span class="n">current_span</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s2">&quot;Starting data fetch&quot;</span><span class="p">)</span>

    <span class="c1"># Simulate async work (e.g., database call)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="n">current_span</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s2">&quot;Data fetch complete&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Async task for item </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2"> finished.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">,</span> <span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">}</span>

<span class="c1"># --- Usage ---</span>
<span class="k">if</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span> <span class="c1"># Good practice to check if initialized</span>
    <span class="n">processed_result</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">({</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">})</span>
    <span class="c1"># await async_task(42) # If running in an async context</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telemetry not initialized, skipping traced function calls.&quot;</span><span class="p">)</span>

</pre></div>
</div>
<p><strong>Explanation:</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">&#64;telemetry.traced()</span></code> decorator automatically wraps the function call in
an OTel span.</p></li>
<li><p>The span starts when the function is entered and ends when it exits (or
raises an exception).</p></li>
<li><p>Duration is automatically calculated.</p></li>
<li><p>Exceptions are automatically recorded, and the span status is set to
<code class="docutils literal notranslate"><span class="pre">ERROR</span></code>.</p></li>
<li><p>You can optionally provide a <code class="docutils literal notranslate"><span class="pre">span_name</span></code>. If omitted, it defaults to the
function’s qualified name (e.g., <code class="docutils literal notranslate"><span class="pre">__main__.process_data</span></code>).</p></li>
<li><p>You can add attributes (<code class="docutils literal notranslate"><span class="pre">kind</span></code>, <code class="docutils literal notranslate"><span class="pre">attributes</span></code>) to the decorator arguments.</p></li>
<li><p>Inside the decorated function, you can get the current span using
<code class="docutils literal notranslate"><span class="pre">trace.get_current_span()</span></code> to add more attributes or events.</p></li>
</ul>
<p><strong>Method 2: Using the <code class="docutils literal notranslate"><span class="pre">start_as_current_span</span></code> context manager (More Control)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming &#39;telemetry&#39; instance is initialized</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Check if telemetry is enabled and get the tracer</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">initialized</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">tracer</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telemetry not available, processing request without tracing.&quot;</span><span class="p">)</span>
        <span class="c1"># Perform work without tracing...</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;processed_untraced&quot;</span><span class="p">}</span>

    <span class="c1"># Start a span using the context manager</span>
    <span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;handle_web_request&quot;</span><span class="p">,</span> <span class="c1"># Descriptive name for the operation</span>
        <span class="n">kind</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">SpanKind</span><span class="o">.</span><span class="n">SERVER</span><span class="p">,</span> <span class="c1"># Indicates this span represents a server receiving a request</span>
        <span class="n">attributes</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Add initial key-value attributes</span>
            <span class="s2">&quot;http.request.id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
            <span class="s2">&quot;http.method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="c1"># Example attribute</span>
            <span class="s2">&quot;feature.flag.X&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># Example attribute</span>
        <span class="p">}</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">parent_span</span><span class="p">:</span> <span class="c1"># The context manager yields the created span object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started span for request: </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">parent_span</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s2">&quot;Request validation started&quot;</span><span class="p">)</span> <span class="c1"># Record an event (timestamped log within the span)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">parent_span</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s2">&quot;Request validation complete&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Simulate doing work, potentially calling other traced functions</span>
            <span class="c1"># You can create nested spans for sub-operations</span>
            <span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;database_query&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_span</span><span class="p">:</span>
                <span class="n">db_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;db.system&quot;</span><span class="p">,</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">)</span>
                <span class="n">db_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;db.statement&quot;</span><span class="p">,</span> <span class="s2">&quot;SELECT * FROM users WHERE id=?&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Executing DB query...&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.08</span><span class="p">)</span> <span class="c1"># Simulate DB call latency</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  DB query complete.&quot;</span><span class="p">)</span>
                <span class="c1"># db_span ends automatically here</span>

            <span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;external_api_call&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">api_span</span><span class="p">:</span>
                <span class="n">api_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;http.url&quot;</span><span class="p">,</span> <span class="s2">&quot;https://api.example.com/data&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Calling external API...&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># Simulate API call latency</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  External API call complete.&quot;</span><span class="p">)</span>
                <span class="c1"># api_span ends automatically here</span>

            <span class="c1"># Set final status (optional, default is OK if no exception)</span>
            <span class="n">parent_span</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Status</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">OK</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished span for request: </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;processed_traced&quot;</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during request </span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Record the exception on the span</span>
            <span class="n">parent_span</span><span class="o">.</span><span class="n">record_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="c1"># Set the span status to Error</span>
            <span class="n">parent_span</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Status</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">StatusCode</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Request failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="c1"># Re-raise the exception if needed</span>
            <span class="k">raise</span>
        <span class="c1"># parent_span ends automatically here, recording duration and status</span>

<span class="c1"># --- Usage ---</span>
<span class="n">handle_request</span><span class="p">(</span><span class="s2">&quot;req-123&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Simulate a request that causes an error</span>
    <span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;failing_operation&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;attempt.number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running operation destined to fail...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Something went wrong intentionally!&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Caught expected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

</pre></div>
</div>
<p><strong>Explanation:</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">telemetry.start_as_current_span(...)</span></code> block creates a span and
makes it the “current” span for its duration.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: The name of the span (operation).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kind</span></code>: The type of operation (e.g., <code class="docutils literal notranslate"><span class="pre">SERVER</span></code> for incoming requests,
<code class="docutils literal notranslate"><span class="pre">CLIENT</span></code> for outgoing calls, <code class="docutils literal notranslate"><span class="pre">INTERNAL</span></code> for internal operations). Defaults
to <code class="docutils literal notranslate"><span class="pre">INTERNAL</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">attributes</span></code>: A dictionary of initial key-value metadata.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">with</span></code> statement yields the created <code class="docutils literal notranslate"><span class="pre">Span</span></code> object, which you can use to:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">set_attribute(key,</span> <span class="pre">value)</span></code>: Add more metadata.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add_event(name,</span> <span class="pre">attributes)</span></code>: Record a timestamped event within the
span’s lifetime.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">record_exception(exception)</span></code>: Mark that an error occurred.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set_status(Status(...))</span></code>: Explicitly set the status (e.g., <code class="docutils literal notranslate"><span class="pre">OK</span></code>,
<code class="docutils literal notranslate"><span class="pre">ERROR</span></code>). If an exception occurs within the <code class="docutils literal notranslate"><span class="pre">with</span></code> block and
<code class="docutils literal notranslate"><span class="pre">set_status_on_exception</span></code> (default True) is used, the status is
automatically set to <code class="docutils literal notranslate"><span class="pre">ERROR</span></code>.</p></li>
</ul>
</li>
<li><p>The span automatically ends when the <code class="docutils literal notranslate"><span class="pre">with</span></code> block exits, calculating the
duration.</p></li>
<li><p>Nested <code class="docutils literal notranslate"><span class="pre">with</span></code> blocks create child spans, forming the trace hierarchy.</p></li>
</ul>
</section>
<section id="creating-metrics">
<h3>5.3 Creating Metrics<a class="headerlink" href="#creating-metrics" title="Link to this heading">#</a></h3>
<p>Metrics measure numerical values over time.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming &#39;telemetry&#39; instance is initialized and metrics are enabled</span>

<span class="c1"># --- 1. Create Metric Instruments (usually done once at startup) ---</span>
<span class="c1"># Counter: Monotonically increasing value (e.g., total requests)</span>
<span class="n">request_counter</span> <span class="o">=</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">create_counter</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;app_requests_total&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total number of HTTP requests received&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;requests&quot;</span> <span class="c1"># Optional unit (follows UCUM standard ideally)</span>
<span class="p">)</span>

<span class="c1"># Histogram: Records the distribution of values (e.g., request latency)</span>
<span class="n">request_latency_hist</span> <span class="o">=</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">create_histogram</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;app_request_latency_seconds&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Distribution of application request latency&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span> <span class="c1"># seconds</span>
<span class="p">)</span>

<span class="c1"># UpDownCounter: Value can increase or decrease (e.g., active connections)</span>
<span class="n">active_connections_counter</span> <span class="o">=</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">create_up_down_counter</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;app_active_connections&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of currently active connections&quot;</span><span class="p">,</span>
    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;connections&quot;</span>
<span class="p">)</span>

<span class="c1"># --- 2. Record Metric Values (done during application execution) ---</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulate_web_request</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">duration_s</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulating request to </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> (Success: </span><span class="si">{</span><span class="n">success</span><span class="si">}</span><span class="s2">, Duration: </span><span class="si">{</span><span class="n">duration_s</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>

    <span class="c1"># Define attributes (dimensions) for the metrics</span>
    <span class="n">metric_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;http.endpoint&quot;</span><span class="p">:</span> <span class="n">endpoint</span><span class="p">,</span> <span class="s2">&quot;request.success&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">success</span><span class="p">)}</span>

    <span class="c1"># Increment the request counter</span>
    <span class="n">request_counter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">metric_attributes</span><span class="p">)</span>

    <span class="c1"># Record the duration in the histogram</span>
    <span class="n">request_latency_hist</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">duration_s</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">metric_attributes</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulate_connection_change</span><span class="p">(</span><span class="n">change</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">server_id</span> <span class="o">=</span> <span class="s2">&quot;server-1&quot;</span> <span class="c1"># Example attribute</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulating connection change: </span><span class="si">{</span><span class="n">change</span><span class="si">:</span><span class="s2">+d</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">server_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">active_connections_counter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">change</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;server.id&quot;</span><span class="p">:</span> <span class="n">server_id</span><span class="p">})</span>

<span class="c1"># --- Usage ---</span>
<span class="k">if</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">initialized</span> <span class="ow">and</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">meter</span><span class="p">:</span> <span class="c1"># Check if metrics are enabled</span>
    <span class="n">simulate_web_request</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">0.055</span><span class="p">)</span>
    <span class="n">simulate_web_request</span><span class="p">(</span><span class="s2">&quot;/products&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">0.120</span><span class="p">)</span>
    <span class="n">simulate_web_request</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">0.530</span><span class="p">)</span> <span class="c1"># Simulate a slow, failed request</span>

    <span class="n">simulate_connection_change</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Connection opened</span>
    <span class="n">simulate_connection_change</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Another connection opened</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">simulate_connection_change</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Connection closed</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telemetry/Metrics not initialized, skipping metric recording.&quot;</span><span class="p">)</span>

<span class="c1"># Metrics are typically exported periodically in the background by the MetricReader.</span>
<span class="c1"># You don&#39;t explicitly call an &#39;export&#39; function here.</span>
</pre></div>
</div>
<p><strong>Explanation:</strong></p>
<ol class="arabic simple">
<li><p><strong>Create Instruments:</strong> You first create metric instruments using
<code class="docutils literal notranslate"><span class="pre">telemetry.create_*</span></code> methods. This is usually done once at application
startup.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">create_counter</span></code>: For values that only increase (e.g., total requests,
bytes sent).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">create_histogram</span></code>: For recording the statistical distribution of values
(e.g., latencies, request sizes). The backend (e.g., Prometheus) will
typically calculate percentiles (p50, p90, p99) from this.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">create_up_down_counter</span></code>: For values that can go up or down (e.g.,
number of active users, items in a queue).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">description</span></code>, <code class="docutils literal notranslate"><span class="pre">unit</span></code>: Provide metadata for the metric.</p></li>
</ul>
</li>
<li><p><strong>Record Values:</strong> During your application’s execution, you call methods on
the created instruments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">counter.add(value,</span> <span class="pre">attributes)</span></code>: Increment the counter. <code class="docutils literal notranslate"><span class="pre">value</span></code> must be
non-negative.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">histogram.record(value,</span> <span class="pre">attributes)</span></code>: Record a measurement.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">up_down_counter.add(value,</span> <span class="pre">attributes)</span></code>: Add the <code class="docutils literal notranslate"><span class="pre">value</span></code> (can be
positive or negative).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">attributes</span></code>: A dictionary of key-value pairs (dimensions) that allow
you to slice and dice the metric data in your backend (e.g., view
request count <em>per endpoint</em>). Attribute values should generally be
strings, numbers, or booleans.</p></li>
</ul>
</li>
</ol>
</section>
<section id="generating-logs">
<h3>5.4 Generating Logs<a class="headerlink" href="#generating-logs" title="Link to this heading">#</a></h3>
<p>Use the trace-aware logger provided by <code class="docutils literal notranslate"><span class="pre">telemetry.logger</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="c1"># Assuming &#39;telemetry&#39; instance is initialized and logging is enabled</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Start a span to provide context for logs</span>
    <span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;process_user_data&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user.id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>

        <span class="c1"># Use the telemetry logger</span>
        <span class="n">telemetry</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Starting data processing for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;custom_field&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">}</span> <span class="c1"># Add extra structured data</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Simulate work</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Working on user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">user_id</span> <span class="o">==</span> <span class="s2">&quot;bad_user&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid user ID encountered&quot;</span><span class="p">)</span>

            <span class="n">telemetry</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="c1"># Debug messages might be filtered by config</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Intermediate step completed.&quot;</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>

            <span class="n">telemetry</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;User data processing finished successfully.&quot;</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;processing.result&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log the error - trace context is automatically included!</span>
            <span class="n">telemetry</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to process data for user </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="c1"># The span context manager handles recording the exception on the span</span>
            <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;processing.result&quot;</span><span class="p">,</span> <span class="s2">&quot;failure&quot;</span><span class="p">)</span>
            <span class="c1"># Decide whether to re-raise or handle the error</span>
            <span class="c1"># raise e</span>

<span class="c1"># --- Usage ---</span>
<span class="k">if</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
    <span class="n">process_user_data</span><span class="p">(</span><span class="s2">&quot;user_123&quot;</span><span class="p">)</span>
    <span class="n">process_user_data</span><span class="p">(</span><span class="s2">&quot;user_456&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">process_user_data</span><span class="p">(</span><span class="s2">&quot;bad_user&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Caught expected processing error for bad_user.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Fallback to basic logging if telemetry isn&#39;t set up</span>
    <span class="n">basic_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">basic_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Telemetry not initialized, using basic logger.&quot;</span><span class="p">)</span>
    <span class="n">basic_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing user data (untraced)...&quot;</span><span class="p">)</span>

</pre></div>
</div>
<p><strong>Explanation:</strong></p>
<ul class="simple">
<li><p>Access the logger via <code class="docutils literal notranslate"><span class="pre">telemetry.logger</span></code>. This logger is configured by
<code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code> to automatically include <code class="docutils literal notranslate"><span class="pre">trace_id</span></code> and <code class="docutils literal notranslate"><span class="pre">span_id</span></code> from
the current span context.</p></li>
<li><p>Use standard Python <code class="docutils literal notranslate"><span class="pre">logging</span></code> levels (<code class="docutils literal notranslate"><span class="pre">logging.INFO</span></code>, <code class="docutils literal notranslate"><span class="pre">logging.ERROR</span></code>,
etc.). The actual output depends on the level configured in <code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">message</span></code> is the main log text.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">extra</span></code> dictionary allows you to add arbitrary key-value pairs for
structured logging. These fields will often be searchable in your logging
backend (like Loki or Elasticsearch).</p></li>
<li><p>When logs are generated within an active span (created by
<code class="docutils literal notranslate"><span class="pre">&#64;telemetry.traced</span></code> or <code class="docutils literal notranslate"><span class="pre">start_as_current_span</span></code>), the trace context is
automatically injected. This allows you to easily find all logs related to a
specific request trace in your backend system.</p></li>
</ul>
</section>
<section id="context-propagation-manual">
<h3>5.5 Context Propagation (Manual)<a class="headerlink" href="#context-propagation-manual" title="Link to this heading">#</a></h3>
<p>When making requests to other services (e.g., HTTP calls), you need to inject
the current trace context into the request headers. When receiving requests, you
need to extract it.</p>
<p><em>(Note: Many web framework instrumentations handle this automatically for
incoming requests and sometimes for outgoing requests using common libraries
like <code class="docutils literal notranslate"><span class="pre">requests</span></code> or <code class="docutils literal notranslate"><span class="pre">httpx</span></code>. This shows the manual process.)</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span> <span class="c1"># Example HTTP client library</span>

<span class="c1"># Assuming &#39;telemetry&#39; instance is initialized and propagation is enabled</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">make_downstream_call</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="c1"># Assume we are already inside an active span (e.g., handling an incoming request)</span>
    <span class="n">current_span</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Making downstream call within span: </span><span class="si">{</span><span class="n">current_span</span><span class="o">.</span><span class="n">get_span_context</span><span class="p">()</span><span class="o">.</span><span class="n">span_id</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 1. Inject Context into Headers</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">propagator</span><span class="p">:</span>
        <span class="n">telemetry</span><span class="o">.</span><span class="n">inject_context</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Injecting headers: </span><span class="si">{</span><span class="n">headers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should contain &#39;traceparent&#39;, maybe &#39;tracestate&#39;, &#39;baggage&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Propagator not available, cannot inject context.&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Make the HTTP Request with Injected Headers</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start a CLIENT span for the outgoing call</span>
            <span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span>
                <span class="s2">&quot;call_downstream_service&quot;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">SpanKind</span><span class="o">.</span><span class="n">CLIENT</span><span class="p">,</span>
                <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;http.url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="s2">&quot;http.method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">}</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">client_span</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="n">client_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;http.status_code&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Downstream call to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> returned status: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span> <span class="c1"># Raise exception for bad status codes</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  HTTP error calling </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Exception is automatically recorded by start_as_current_span</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error calling </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Exception is automatically recorded by start_as_current_span</span>
            <span class="k">raise</span>

<span class="k">def</span><span class="w"> </span><span class="nf">handle_incoming_request</span><span class="p">(</span><span class="n">request_headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handling incoming request with headers: </span><span class="si">{</span><span class="n">request_headers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 1. Extract Context from Headers</span>
    <span class="n">extracted_context</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">propagator</span><span class="p">:</span>
        <span class="n">extracted_context</span> <span class="o">=</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">extract_context</span><span class="p">(</span><span class="n">request_headers</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Extracted context: </span><span class="si">{</span><span class="n">extracted_context</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># This is an OTel Context object</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Propagator not available, cannot extract context.&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Start a SERVER Span using the Extracted Context</span>
    <span class="c1"># If extracted_context is None or empty, a new trace will be started.</span>
    <span class="c1"># Otherwise, this span becomes a child of the trace specified in the headers.</span>
    <span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span>
        <span class="s2">&quot;process_incoming_call&quot;</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="n">extracted_context</span><span class="p">,</span> <span class="c1"># Pass the extracted context here!</span>
        <span class="n">kind</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">SpanKind</span><span class="o">.</span><span class="n">SERVER</span><span class="p">,</span>
        <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;service.entrypoint&quot;</span><span class="p">:</span> <span class="s2">&quot;/incoming&quot;</span><span class="p">}</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">server_span</span><span class="p">:</span>
        <span class="n">trace_id</span> <span class="o">=</span> <span class="n">server_span</span><span class="o">.</span><span class="n">get_span_context</span><span class="p">()</span><span class="o">.</span><span class="n">trace_id</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Started server span with Trace ID: </span><span class="si">{</span><span class="n">trace_id</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># ... process the request ...</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.06</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Finished processing incoming call.&quot;</span><span class="p">)</span>

<span class="c1"># --- Usage Simulation ---</span>
<span class="c1"># Simulate being inside a request handler span</span>
<span class="k">with</span> <span class="n">telemetry</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="s2">&quot;main_request_handler&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">main_span</span><span class="p">:</span>
    <span class="c1"># Simulate making an outgoing call</span>
    <span class="c1"># await make_downstream_call(&quot;http://example.com/api&quot;, {&quot;key&quot;: &quot;value&quot;}) # If async</span>

    <span class="c1"># Simulate receiving a request with trace headers</span>
    <span class="n">incoming_headers_with_trace</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;traceparent&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;00-</span><span class="si">{</span><span class="n">main_span</span><span class="o">.</span><span class="n">get_span_context</span><span class="p">()</span><span class="o">.</span><span class="n">trace_id</span><span class="si">:</span><span class="s2">032x</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">016x</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
        <span class="c1"># Potentially also &#39;tracestate&#39; and &#39;baggage&#39; headers</span>
    <span class="p">}</span>
    <span class="n">handle_incoming_request</span><span class="p">(</span><span class="n">incoming_headers_with_trace</span><span class="p">)</span>

    <span class="c1"># Simulate receiving a request without trace headers (starts a new trace)</span>
    <span class="n">incoming_headers_without_trace</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
    <span class="p">}</span>
    <span class="n">handle_incoming_request</span><span class="p">(</span><span class="n">incoming_headers_without_trace</span><span class="p">)</span>

</pre></div>
</div>
<p><strong>Explanation:</strong></p>
<ul class="simple">
<li><p><strong>Injection (<code class="docutils literal notranslate"><span class="pre">inject_context</span></code>):</strong> Before making an outgoing request (e.g.,
HTTP, gRPC, message queue), create an empty dictionary (<code class="docutils literal notranslate"><span class="pre">headers</span> <span class="pre">=</span> <span class="pre">{}</span></code>) and
call <code class="docutils literal notranslate"><span class="pre">telemetry.inject_context(headers)</span></code>. The configured propagator (e.g.,
W3C TraceContext) will add the necessary headers (<code class="docutils literal notranslate"><span class="pre">traceparent</span></code>, etc.) to
the dictionary. Include these headers in your outgoing request.</p></li>
<li><p><strong>Extraction (<code class="docutils literal notranslate"><span class="pre">extract_context</span></code>):</strong> When receiving a request, get the
incoming headers into a dictionary (<code class="docutils literal notranslate"><span class="pre">request_headers</span></code>). Call
<code class="docutils literal notranslate"><span class="pre">telemetry.extract_context(request_headers)</span></code>. This returns an OTel <code class="docutils literal notranslate"><span class="pre">Context</span></code>
object containing the trace information from the headers (or an empty
context if no headers were found).</p></li>
<li><p><strong>Using Extracted Context:</strong> Pass the <code class="docutils literal notranslate"><span class="pre">extracted_context</span></code> to the <code class="docutils literal notranslate"><span class="pre">context</span></code>
argument of <code class="docutils literal notranslate"><span class="pre">telemetry.start_as_current_span(...)</span></code> when starting the span
for handling the incoming request. This links the new span as a child of the
trace initiated by the upstream service.</p></li>
</ul>
</section>
<section id="shutdown">
<h3>5.6 Shutdown<a class="headerlink" href="#shutdown" title="Link to this heading">#</a></h3>
<p>As shown in the Initialization example, always ensure <code class="docutils literal notranslate"><span class="pre">telemetry.shutdown()</span></code> is
called before your application exits.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># At the very end of your application&#39;s lifecycle</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Application shutting down...&quot;</span><span class="p">)</span>
<span class="n">telemetry</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Telemetry shutdown complete.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="comprehensive-telemetry-flow-model-end-to-end">
<h2>6. Comprehensive Telemetry Flow Model (End-to-End)<a class="headerlink" href="#comprehensive-telemetry-flow-model-end-to-end" title="Link to this heading">#</a></h2>
<p>This section details the journey of telemetry data from start to finish,
expanding on the original documentation and linking it explicitly to the
<code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> library and the demo environment components.</p>
<section id="phase-0-initialization-and-configuration">
<h3>6.1 Phase 0: Initialization and Configuration<a class="headerlink" href="#phase-0-initialization-and-configuration" title="Link to this heading">#</a></h3>
<ul>
<li><p><strong>What:</strong> Setting up the telemetry system before any data is generated.</p></li>
<li><p><strong>Where:</strong> Application startup code.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Components:</strong> <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code>, <code class="docutils literal notranslate"><span class="pre">Telemetry.from_settings</span></code>,
<code class="docutils literal notranslate"><span class="pre">TelemetryBuilder</span></code>, <code class="docutils literal notranslate"><span class="pre">ResourceFactory</span></code>, <code class="docutils literal notranslate"><span class="pre">PropagatorFactory</span></code>,
<code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code>.</p></li>
<li><p><strong>Steps:</strong></p>
<ol class="arabic">
<li><p><strong>Load Configuration:</strong> <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> loads configuration from
environment variables (or <code class="docutils literal notranslate"><span class="pre">.env.local</span></code> via <code class="docutils literal notranslate"><span class="pre">dotenv</span></code>). Pydantic validates
the settings.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># settings.py loads env vars like SERVICE__NAME, TRACING__EXPORTER_TYPE etc.</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">TelemetrySettings</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Instantiate Facade:</strong> <code class="docutils literal notranslate"><span class="pre">Telemetry.from_settings(settings)</span></code> is called.
This triggers the singleton creation.</p></li>
<li><p><strong>Build Components:</strong> Inside <code class="docutils literal notranslate"><span class="pre">Telemetry.__init__</span></code> (called only once),
<code class="docutils literal notranslate"><span class="pre">TelemetryBuilder(settings).build()</span></code> is invoked.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ResourceFactory.from_settings(settings).create()</span></code>: Creates the
<code class="docutils literal notranslate"><span class="pre">Resource</span></code> object (service name, version, etc.).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PropagatorFactory.from_settings(settings).create()</span></code>: Creates the
<code class="docutils literal notranslate"><span class="pre">CompositePropagator</span></code> (e.g., W3C TraceContext + Baggage).</p></li>
<li><p>Factories for Exporters, Processors/Readers, and Samplers are
created based on settings.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code> instances
are created, injecting their required factories and the <code class="docutils literal notranslate"><span class="pre">Resource</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Setup Components:</strong> <code class="docutils literal notranslate"><span class="pre">TelemetryComponents.setup_all()</span></code> calls the
<code class="docutils literal notranslate"><span class="pre">setup()</span></code> method on each component (<code class="docutils literal notranslate"><span class="pre">PropagatorComponent</span></code>,
<code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PropagatorComponent.setup()</span></code>: Sets the global text map propagator.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TracingComponent.setup()</span></code>: Creates and sets the global
<code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code> (with Resource, Sampler, Processor). Gets the
<code class="docutils literal notranslate"><span class="pre">Tracer</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MetricsComponent.setup()</span></code>: Creates and sets the global
<code class="docutils literal notranslate"><span class="pre">MeterProvider</span></code> (with Resource, Reader). Gets the <code class="docutils literal notranslate"><span class="pre">Meter</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LoggingComponent.setup()</span></code>: Creates the <code class="docutils literal notranslate"><span class="pre">LoggerProvider</span></code>,
instruments the standard <code class="docutils literal notranslate"><span class="pre">logging</span></code> library, gets the trace-aware
<code class="docutils literal notranslate"><span class="pre">Logger</span></code>.</p></li>
</ul>
</li>
</ol>
</li>
<li><p><strong>Result:</strong> The <code class="docutils literal notranslate"><span class="pre">telemetry</span></code> object is ready, and the global OTel SDK
providers are configured. The application can now generate telemetry.</p></li>
</ul>
</section>
<section id="phase-1-telemetry-generation-inside-your-app">
<h3>6.2 Phase 1: Telemetry Generation (Inside Your App)<a class="headerlink" href="#phase-1-telemetry-generation-inside-your-app" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>What:</strong> Creating traces, metrics, and logs during application runtime.</p></li>
<li><p><strong>Where:</strong> Your application code (e.g., request handlers, background tasks).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Components:</strong> <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> facade methods (<code class="docutils literal notranslate"><span class="pre">traced</span></code>,
<code class="docutils literal notranslate"><span class="pre">start_as_current_span</span></code>, <code class="docutils literal notranslate"><span class="pre">create_counter</span></code>, <code class="docutils literal notranslate"><span class="pre">log</span></code>, etc.).</p></li>
<li><p><strong>Steps &amp; Data:</strong></p>
<ol class="arabic simple">
<li><p><strong>Trace Generation:</strong></p>
<ul>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">&#64;telemetry.traced</span></code> or
<code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">telemetry.start_as_current_span(...)</span></code>.</p></li>
<li><p><strong>Data Created:</strong> Span objects containing: Name, Kind (SERVER,
CLIENT, INTERNAL), Start/End Timestamps (Duration), Attributes
(key-value metadata), Events (timestamped annotations), Status
(OK/ERROR), Parent Span ID (linking), Trace ID.</p></li>
</ul>
</li>
<li><p><strong>Metric Recording:</strong></p>
<ul>
<li><p>Calling <code class="docutils literal notranslate"><span class="pre">add()</span></code> or <code class="docutils literal notranslate"><span class="pre">record()</span></code> on instruments created via
<code class="docutils literal notranslate"><span class="pre">telemetry.create_*</span></code>.</p></li>
<li><p><strong>Data Created:</strong> Metric data points including: Value, Timestamp,
Attributes (dimensions). These are aggregated <em>in memory</em> by the SDK
(e.g., counters are summed, histograms build distributions).</p></li>
</ul>
</li>
<li><p><strong>Log Generation:</strong></p>
<ul>
<li><p>Calling <code class="docutils literal notranslate"><span class="pre">telemetry.log(level,</span> <span class="pre">message,</span> <span class="pre">extra)</span></code>.</p></li>
<li><p><strong>Data Created:</strong> Log records containing: Timestamp, Severity
(Level), Body (Message), Attributes (<code class="docutils literal notranslate"><span class="pre">extra</span></code> dict), <strong>Trace ID</strong>,
<strong>Span ID</strong> (automatically injected by the instrumented logger).</p></li>
</ul>
</li>
</ol>
</li>
<li><p><strong>In-Memory Accumulation:</strong> This generated data isn’t sent immediately.</p>
<ul>
<li><p>Completed Spans go to the <code class="docutils literal notranslate"><span class="pre">SpanProcessor</span></code>’s queue (e.g.,
<code class="docutils literal notranslate"><span class="pre">BatchSpanProcessor</span></code>).</p></li>
<li><p>Metric updates modify in-memory aggregators within the <code class="docutils literal notranslate"><span class="pre">MeterProvider</span></code>.</p></li>
<li><p>Log records go to the <code class="docutils literal notranslate"><span class="pre">LogRecordProcessor</span></code>’s queue (e.g.,
<code class="docutils literal notranslate"><span class="pre">BatchLogRecordProcessor</span></code>).</p></li>
</ul>
</li>
<li><p><strong>Why Accumulate?</strong> Batching improves performance by reducing the number of
export operations (network calls).</p></li>
<li><p><strong>Risk:</strong> If the application crashes before data is exported, buffered data
can be lost.</p></li>
</ul>
</section>
<section id="phase-2-context-propagation-linking-services">
<h3>6.3 Phase 2: Context Propagation (Linking Services)<a class="headerlink" href="#phase-2-context-propagation-linking-services" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>What:</strong> Ensuring trace context (Trace ID, Span ID, sampling decision,
baggage) is passed between different services when they communicate.</p></li>
<li><p><strong>Where:</strong> Code that makes outgoing requests (e.g., HTTP client calls) and
code that handles incoming requests (e.g., web framework middleware).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Components:</strong> <code class="docutils literal notranslate"><span class="pre">telemetry.inject_context</span></code>,
<code class="docutils literal notranslate"><span class="pre">telemetry.extract_context</span></code>, <code class="docutils literal notranslate"><span class="pre">PropagatorComponent</span></code>.</p></li>
<li><p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p><strong>Injection (Outgoing Call):</strong></p>
<ul>
<li><p>Before making the call, create a carrier dictionary: <code class="docutils literal notranslate"><span class="pre">headers</span> <span class="pre">=</span> <span class="pre">{}</span></code>.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">telemetry.inject_context(headers)</span></code>.</p></li>
<li><p>The configured global propagator (e.g., <code class="docutils literal notranslate"><span class="pre">CompositePropagator</span></code> using
W3C TraceContext and Baggage) adds headers like
<code class="docutils literal notranslate"><span class="pre">traceparent:</span> <span class="pre">00-trace_id-span_id-flags</span></code> and potentially
<code class="docutils literal notranslate"><span class="pre">baggage:</span> <span class="pre">key1=value1</span></code> to the <code class="docutils literal notranslate"><span class="pre">headers</span></code> dictionary.</p></li>
<li><p>Include these <code class="docutils literal notranslate"><span class="pre">headers</span></code> in the outgoing request (e.g.,
<code class="docutils literal notranslate"><span class="pre">httpx.post(url,</span> <span class="pre">headers=headers)</span></code>).</p></li>
</ul>
</li>
<li><p><strong>Extraction (Incoming Request):</strong></p>
<ul>
<li><p>When a request arrives, get the headers into a dictionary:
<code class="docutils literal notranslate"><span class="pre">request_headers</span> <span class="pre">=</span> <span class="pre">dict(request.headers)</span></code>.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">context</span> <span class="pre">=</span> <span class="pre">telemetry.extract_context(request_headers)</span></code>.</p></li>
<li><p>The global propagator reads headers like <code class="docutils literal notranslate"><span class="pre">traceparent</span></code> and <code class="docutils literal notranslate"><span class="pre">baggage</span></code>
and returns an OTel <code class="docutils literal notranslate"><span class="pre">Context</span></code> object containing the upstream trace
information.</p></li>
<li><p>Pass this <code class="docutils literal notranslate"><span class="pre">context</span></code> object when starting the new span for handling
this request:
<code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">telemetry.start_as_current_span(...,</span> <span class="pre">context=context,</span> <span class="pre">kind=SpanKind.SERVER):</span></code>.
This links the new span as a child of the upstream span.</p></li>
</ul>
</li>
</ol>
</li>
<li><p><strong>Result:</strong> Traces can span multiple services, providing an end-to-end view
of requests.</p></li>
</ul>
</section>
<section id="phase-3-sdk-processing-and-export-sending-data-out">
<h3>6.4 Phase 3: SDK Processing and Export (Sending Data Out)<a class="headerlink" href="#phase-3-sdk-processing-and-export-sending-data-out" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>What:</strong> Preparing accumulated telemetry data and sending it from the
application’s OTel SDK to the configured destination (usually the OTel
Collector).</p></li>
<li><p><strong>Where:</strong> Background threads managed by the OTel SDK’s Processors and
Readers.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Components:</strong> <code class="docutils literal notranslate"><span class="pre">SpanProcessor</span></code> (Batch/Simple), <code class="docutils literal notranslate"><span class="pre">MetricReader</span></code>
(Periodic), <code class="docutils literal notranslate"><span class="pre">LogRecordProcessor</span></code> (Batch/Simple), <code class="docutils literal notranslate"><span class="pre">SpanExporter</span></code>
(OTLP/Console), <code class="docutils literal notranslate"><span class="pre">MetricExporter</span></code> (OTLP/Console), <code class="docutils literal notranslate"><span class="pre">LogExporter</span></code>
(OTLP/Console). Configuration from <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricsConfig</span></code>,
<code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code>.</p></li>
<li><p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p><strong>Batching Trigger:</strong> Export happens when:</p>
<ul>
<li><p>A batch processor’s queue reaches <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> (spans/logs).</p></li>
<li><p>A batch processor’s <code class="docutils literal notranslate"><span class="pre">schedule_delay_millis</span></code> timer expires
(spans/logs).</p></li>
<li><p>A metric reader’s <code class="docutils literal notranslate"><span class="pre">export_interval_millis</span></code> timer expires (metrics).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">telemetry.shutdown()</span></code> is called (triggers a final flush/export).</p></li>
</ul>
</li>
<li><p><strong>Data Transformation (Internal):</strong></p>
<ul>
<li><p>Spans: Finalized with duration, status.</p></li>
<li><p>Metrics: Aggregated values (sums, counts, histogram buckets) are
prepared for export.</p></li>
<li><p>Logs: Formatted.</p></li>
</ul>
</li>
<li><p><strong>Exporter Selection:</strong> The processor/reader uses the specific exporter
instance created during Phase 0 based on <code class="docutils literal notranslate"><span class="pre">exporter_type</span></code> settings (e.g.,
<code class="docutils literal notranslate"><span class="pre">OTLPSpanExporter</span></code>).</p></li>
<li><p><strong>Serialization:</strong> Data is converted into the format required by the
exporter:</p>
<ul>
<li><p><strong>OTLP:</strong> Serialized into Google Protocol Buffers (Protobuf), a
binary format.</p></li>
<li><p><strong>Console:</strong> Formatted as human-readable text.</p></li>
</ul>
</li>
<li><p><strong>Transmission:</strong> The exporter sends the serialized data:</p>
<ul>
<li><p><strong>OTLP/gRPC:</strong> Makes a gRPC network call to the Collector’s endpoint
(e.g., <code class="docutils literal notranslate"><span class="pre">http://localhost:4317</span></code>, configured via <code class="docutils literal notranslate"><span class="pre">collector.url</span></code>).
Uses HTTP/2.</p></li>
<li><p><strong>OTLP/HTTP:</strong> Makes an HTTP POST request (with Protobuf payload) to
the Collector’s endpoint (e.g., <code class="docutils literal notranslate"><span class="pre">http://localhost:4318</span></code>).</p></li>
<li><p><strong>Console:</strong> Writes to standard output.</p></li>
</ul>
</li>
<li><p><strong>Reliability:</strong> Exporters typically handle connection timeouts
(<code class="docutils literal notranslate"><span class="pre">timeout_millis</span></code>) and may have basic retry logic for transient network
errors.</p></li>
</ol>
</li>
</ul>
</section>
<section id="phase-4-collector-reception-and-processing-central-hub">
<h3>6.5 Phase 4: Collector Reception and Processing (Central Hub)<a class="headerlink" href="#phase-4-collector-reception-and-processing-central-hub" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>What:</strong> The OTel Collector receives data from the application SDK,
processes it further, and routes it.</p></li>
<li><p><strong>Where:</strong> The <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code> service defined in
<code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>. Configuration in <code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code>.</p></li>
<li><p><strong>Components:</strong> Collector <code class="docutils literal notranslate"><span class="pre">receivers</span></code>, <code class="docutils literal notranslate"><span class="pre">processors</span></code>, <code class="docutils literal notranslate"><span class="pre">service</span></code>/<code class="docutils literal notranslate"><span class="pre">pipelines</span></code>.</p></li>
<li><p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p><strong>Reception:</strong> The configured <code class="docutils literal notranslate"><span class="pre">receivers</span></code> listen for incoming data.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">otlp</span></code> receiver listens on ports <code class="docutils literal notranslate"><span class="pre">4317</span></code> (gRPC) and <code class="docutils literal notranslate"><span class="pre">4318</span></code> (HTTP) as
defined in <code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code>.</p></li>
<li><p>It accepts connections, parses the protocol, deserializes the
Protobuf messages, and converts them into the Collector’s internal
data format.</p></li>
</ul>
</li>
<li><p><strong>Pipeline Routing:</strong> The <code class="docutils literal notranslate"><span class="pre">service.pipelines</span></code> section directs data based
on type (traces, metrics, logs) to the appropriate pipeline.</p>
<ul>
<li><p>Example: Incoming OTLP traces go to the <code class="docutils literal notranslate"><span class="pre">traces</span></code> pipeline.</p></li>
</ul>
</li>
<li><p><strong>Processing:</strong> Data flows through the <code class="docutils literal notranslate"><span class="pre">processors</span></code> listed in its
pipeline (e.g., <code class="docutils literal notranslate"><span class="pre">[batch]</span></code> in the example config).</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">batch</span></code>: Can perform additional batching for efficiency before
exporting to backends.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memory_limiter</span></code> (Optional): Prevents the collector from crashing
due to excessive memory usage under high load by dropping data if
limits are exceeded.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resource</span></code> (Optional): Can add/modify resource attributes (e.g., add
Kubernetes metadata).</p></li>
<li><p>Other processors exist for filtering, sampling (tail-based),
attribute manipulation, etc.</p></li>
</ul>
</li>
</ol>
</li>
<li><p><strong>Result:</strong> Telemetry data is potentially transformed, enriched, and
batched, ready for export to specialized backends.</p></li>
</ul>
</section>
<section id="phase-5-collector-export-to-backends">
<h3>6.6 Phase 5: Collector Export (To Backends)<a class="headerlink" href="#phase-5-collector-export-to-backends" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>What:</strong> The OTel Collector sends the processed data to the final backend
systems.</p></li>
<li><p><strong>Where:</strong> The <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code> service. Configuration in
<code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code>.</p></li>
<li><p><strong>Components:</strong> Collector <code class="docutils literal notranslate"><span class="pre">exporters</span></code>, <code class="docutils literal notranslate"><span class="pre">service</span></code>/<code class="docutils literal notranslate"><span class="pre">pipelines</span></code>.</p></li>
<li><p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p><strong>Exporter Selection:</strong> The pipeline routes data to the configured
<code class="docutils literal notranslate"><span class="pre">exporters</span></code>.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">traces</span></code> pipeline -&gt; <code class="docutils literal notranslate"><span class="pre">otlp</span></code> exporter (sending to Jaeger), <code class="docutils literal notranslate"><span class="pre">debug</span></code>
exporter.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metrics</span></code> pipeline -&gt; <code class="docutils literal notranslate"><span class="pre">prometheus</span></code> exporter, <code class="docutils literal notranslate"><span class="pre">debug</span></code> exporter.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logs</span></code> pipeline -&gt; <code class="docutils literal notranslate"><span class="pre">debug</span></code> exporter.</p></li>
</ul>
</li>
<li><p><strong>Protocol/Format:</strong> Each exporter uses the protocol and format required
by its destination:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">otlp</span></code> exporter (to Jaeger): Sends OTLP/gRPC to <code class="docutils literal notranslate"><span class="pre">jaeger:4317</span></code> (as
configured in <code class="docutils literal notranslate"><span class="pre">exporters.otlp.endpoint</span></code>). The hostname <code class="docutils literal notranslate"><span class="pre">jaeger</span></code>
resolves to the Jaeger container’s IP address because they are on
the same <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code> Docker network. <code class="docutils literal notranslate"><span class="pre">tls.insecure:</span> <span class="pre">true</span></code> means TLS
is not used for this connection <em>within</em> the Docker network.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prometheus</span></code> exporter: Doesn’t actively push. It opens an HTTP
endpoint (<code class="docutils literal notranslate"><span class="pre">0.0.0.0:8889</span></code> as configured) and serves metrics in the
Prometheus text format when Prometheus scrapes it.
<code class="docutils literal notranslate"><span class="pre">resource_to_telemetry_conversion:</span> <span class="pre">enabled:</span> <span class="pre">true</span></code> helps convert OTel
resource attributes (like <code class="docutils literal notranslate"><span class="pre">service.name</span></code>) into Prometheus labels.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">debug</span></code> exporter: Writes detailed telemetry data to the Collector’s
standard output (useful for troubleshooting).</p></li>
</ul>
</li>
<li><p><strong>Interaction Model:</strong></p>
<ul>
<li><p>Traces (to Jaeger): <strong>Push</strong> model. Collector actively sends data.</p></li>
<li><p>Metrics (to Prometheus): <strong>Pull</strong> model. Collector exposes an
endpoint; Prometheus scrapes it.</p></li>
<li><p>Logs (to Debug): <strong>Push</strong> model (to console).</p></li>
</ul>
</li>
<li><p><strong>Reliability:</strong> Collector exporters typically have more robust retry
mechanisms (e.g., exponential backoff) and potentially queuing
capabilities (persistent or in-memory) to handle temporary backend
unavailability.</p></li>
</ol>
</li>
</ul>
</section>
<section id="phase-6-backend-storage-and-indexing-saving-data">
<h3>6.7 Phase 6: Backend Storage and Indexing (Saving Data)<a class="headerlink" href="#phase-6-backend-storage-and-indexing-saving-data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>What:</strong> The specialized backend systems receive data from the Collector
and store it efficiently for later querying.</p></li>
<li><p><strong>Where:</strong> <code class="docutils literal notranslate"><span class="pre">jaeger</span></code> and <code class="docutils literal notranslate"><span class="pre">prometheus</span></code> services in <code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>.</p></li>
<li><p><strong>Components:</strong> Jaeger storage engine, Prometheus TSDB (Time-Series
Database).</p></li>
<li><p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p><strong>Jaeger (Traces):</strong></p>
<ul>
<li><p>Receives OTLP trace data from the Collector on port 4317.</p></li>
<li><p><strong>Storage:</strong> In the demo setup (<code class="docutils literal notranslate"><span class="pre">SPAN_STORAGE_TYPE=memory</span></code>), traces
are stored <strong>only in RAM</strong> and are lost when Jaeger restarts.
Production setups typically use persistent storage like
Elasticsearch or Cassandra, configured via environment variables.</p></li>
<li><p><strong>Indexing:</strong> Indexes spans by Trace ID, service name, operation
name, time, and attributes (tags) to allow fast searching via the UI
or API.</p></li>
</ul>
</li>
<li><p><strong>Prometheus (Metrics):</strong></p>
<ul>
<li><p><strong>Scraping:</strong> Periodically (defined in <code class="docutils literal notranslate"><span class="pre">prometheus.yml</span></code>, typically
15-60s) sends an HTTP GET request to the Collector’s Prometheus
exporter endpoint (<code class="docutils literal notranslate"><span class="pre">otel-collector:8889</span></code>).</p></li>
<li><p><strong>Storage:</strong> Parses the text-format response and stores the metrics
in its local <strong>Time-Series Database (TSDB)</strong> on disk (inside the
container, potentially mapped to a host volume for persistence if
configured).</p></li>
<li><p><strong>Data Model:</strong> Stores data as
<code class="docutils literal notranslate"><span class="pre">metric_name{label1=&quot;value1&quot;,</span> <span class="pre">label2=&quot;value2&quot;}</span> <span class="pre">timestamp</span> <span class="pre">value</span></code>.</p></li>
<li><p><strong>Indexing:</strong> Efficiently indexes metrics by name and labels.</p></li>
<li><p><strong>Retention:</strong> Data is typically kept for a configurable period
(e.g., 15 days) before being deleted.</p></li>
</ul>
</li>
<li><p><strong>Loki (Logs - Future):</strong> Would receive logs (likely via OTLP or a
specific Loki exporter in the Collector), index them based on labels
(like <code class="docutils literal notranslate"><span class="pre">service.name</span></code>, <code class="docutils literal notranslate"><span class="pre">level</span></code>), and store the log content compressed.</p></li>
</ol>
</li>
</ul>
</section>
<section id="phase-7-query-and-visualization-using-data">
<h3>6.8 Phase 7: Query and Visualization (Using Data)<a class="headerlink" href="#phase-7-query-and-visualization-using-data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>What:</strong> Users or other systems accessing the stored telemetry data for
analysis, dashboarding, and alerting.</p></li>
<li><p><strong>Where:</strong> Jaeger UI, Prometheus UI, Grafana (if added), APIs.</p></li>
<li><p><strong>Components:</strong> Backend query engines and UIs.</p></li>
<li><p><strong>Steps:</strong></p>
<ol class="arabic simple">
<li><p><strong>Jaeger UI:</strong></p>
<ul>
<li><p>Accessible via the mapped port (default <code class="docutils literal notranslate"><span class="pre">16686</span></code> on the host, e.g.,
<code class="docutils literal notranslate"><span class="pre">http://localhost:16686</span></code>).</p></li>
<li><p>Allows searching for traces by service, operation, tags
(attributes), duration, time range.</p></li>
<li><p>Visualizes trace timelines (Gantt charts) showing parent-child
relationships and durations.</p></li>
</ul>
</li>
<li><p><strong>Prometheus UI / PromQL:</strong></p>
<ul>
<li><p>Accessible via the mapped port (default <code class="docutils literal notranslate"><span class="pre">9090</span></code> on the host, e.g.,
<code class="docutils literal notranslate"><span class="pre">http://localhost:9090</span></code>).</p></li>
<li><p>Provides an interface to write <strong>PromQL</strong> queries to select,
aggregate, and transform metrics over time (e.g., calculate rates,
sums, averages, percentiles).</p></li>
<li><p>Basic graphing capabilities.</p></li>
<li><p>Used to define alerting rules.</p></li>
</ul>
</li>
<li><p><strong>Grafana (If Added):</strong></p>
<ul>
<li><p>Connects to Jaeger and Prometheus (and potentially Loki) as data
sources.</p></li>
<li><p>Allows building sophisticated dashboards combining traces, metrics,
and logs.</p></li>
<li><p>Provides advanced visualization options and alerting features.</p></li>
</ul>
</li>
<li><p><strong>Correlation:</strong> A key benefit is correlating different signals. For
example:</p>
<ul>
<li><p>Clicking on a point in a Grafana metric graph might provide a link
to relevant traces in Jaeger from that time.</p></li>
<li><p>Viewing a trace in Jaeger might allow you to jump to related logs
using the Trace ID.</p></li>
</ul>
</li>
</ol>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="understanding-the-demo-environment-docker-compose-local-yml">
<h2>7. Understanding the Demo Environment (<code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>)<a class="headerlink" href="#understanding-the-demo-environment-docker-compose-local-yml" title="Link to this heading">#</a></h2>
<p>This file uses Docker Compose to define and run the multi-container application
environment needed for development and demonstration.</p>
<section id="what-is-docker-compose">
<h3>7.1 What is Docker Compose?<a class="headerlink" href="#what-is-docker-compose" title="Link to this heading">#</a></h3>
<p>Docker Compose is a tool for defining and running multi-container Docker
applications. You use a YAML file (like <code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>) to configure
your application’s services, networks, and volumes. Then, with a single command
(<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">up</span></code>), you can create and start all the services from your
configuration.</p>
</section>
<section id="service-otel-collector">
<h3>7.2 Service: <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code><a class="headerlink" href="#service-otel-collector" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Purpose:</strong> Runs the OpenTelemetry Collector.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">image</span></code>:</strong>
<code class="docutils literal notranslate"><span class="pre">otel/opentelemetry-collector-contrib:${OTEL_COLLECTOR_CONTRIB_VERSION:-0.123.0}</span></code></p>
<ul>
<li><p>Uses the official “contrib” image, which includes many extra components
not in the base <code class="docutils literal notranslate"><span class="pre">otel/opentelemetry-collector</span></code> image.</p></li>
<li><p>Uses an environment variable <code class="docutils literal notranslate"><span class="pre">OTEL_COLLECTOR_CONTRIB_VERSION</span></code> for the
version, defaulting to <code class="docutils literal notranslate"><span class="pre">0.123.0</span></code>. This allows easy version updates via
the <code class="docutils literal notranslate"><span class="pre">.env.local</span></code> file.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">container_name</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">${OTEL_COLLECTOR_CONTAINER_NAME:-otel-collector}</span></code></p>
<ul>
<li><p>Sets a predictable name for the container, defaulting to
<code class="docutils literal notranslate"><span class="pre">otel-collector</span></code>.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">command</span></code>:</strong>
<code class="docutils literal notranslate"><span class="pre">[&quot;--config=${OTEL_CONFIG_CONTAINER_PATH:-/etc/otel-collector-config.yaml}&quot;]</span></code></p>
<ul>
<li><p>Tells the collector process inside the container which configuration
file to load. The path <code class="docutils literal notranslate"><span class="pre">/etc/otel-collector-config.yaml</span></code> is the location
<em>inside</em> the container.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">volumes</span></code>:</strong>
<code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">${OTEL_CONFIG_HOST_PATH:-./config/collector-config.yaml}:/${OTEL_CONFIG_CONTAINER_PATH:-/etc/otel-collector-config.yaml}</span></code></p>
<ul>
<li><p><strong>Crucial:</strong> Mounts the local <code class="docutils literal notranslate"><span class="pre">config/collector-config.yaml</span></code> file (on
your host machine) into the container at
<code class="docutils literal notranslate"><span class="pre">/etc/otel-collector-config.yaml</span></code>. This allows you to edit the collector
configuration locally, and the running collector will see the changes
(though a restart via <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">compose</span> <span class="pre">restart</span> <span class="pre">otel-collector</span></code> is usually
needed to apply them).</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ports</span></code>:</strong> Maps ports from your host machine to the container:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">4317:4317</span></code>: Exposes the OTLP/gRPC receiver port. Your application
(<code class="docutils literal notranslate"><span class="pre">web</span></code> service or local scripts) sends data here.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">4318:4318</span></code>: Exposes the OTLP/HTTP receiver port.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">8888:8888</span></code>: Potentially exposes the collector’s <em>internal</em> Prometheus
metrics (if configured in collector config’s <code class="docutils literal notranslate"><span class="pre">telemetry</span></code> section).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">8889:8889</span></code>: Exposes the <code class="docutils literal notranslate"><span class="pre">prometheus</span></code> exporter endpoint. The
<code class="docutils literal notranslate"><span class="pre">prometheus</span></code> service scrapes this port.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">13133:13133</span></code>: Exposes the <code class="docutils literal notranslate"><span class="pre">health_check</span></code> extension endpoint.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">depends_on</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">jaeger</span></code>, <code class="docutils literal notranslate"><span class="pre">prometheus</span></code></p>
<ul>
<li><p>Ensures Docker Compose starts Jaeger and Prometheus <em>before</em> starting
the collector. This doesn’t guarantee they are <em>ready</em>, just started.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">networks</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code></p>
<ul>
<li><p>Connects the collector to the custom Docker network, allowing it to
communicate with other services (like <code class="docutils literal notranslate"><span class="pre">jaeger</span></code>) using their service
names.</p></li>
</ul>
</li>
</ul>
</section>
<section id="service-jaeger">
<h3>7.3 Service: <code class="docutils literal notranslate"><span class="pre">jaeger</span></code><a class="headerlink" href="#service-jaeger" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Purpose:</strong> Runs the Jaeger distributed tracing backend (UI, query,
collector, storage - all-in-one image).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">image</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">jaegertracing/jaeger:${JAEGER_VERSION:-2.2.0}</span></code></p>
<ul>
<li><p>Uses the official Jaeger all-in-one image, version controlled by
<code class="docutils literal notranslate"><span class="pre">JAEGER_VERSION</span></code> env var.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">container_name</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">${JAEGER_CONTAINER_NAME:-jaeger}</span></code></p>
<ul>
<li><p>Sets a predictable container name.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ports</span></code>:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">16686:16686</span></code>: Exposes the Jaeger Web UI port. You access this in your
browser (<code class="docutils literal notranslate"><span class="pre">http://localhost:16686</span></code>).</p></li>
<li><p>Other ports (like 4317, 4318 for OTLP) are commented out because the
<code class="docutils literal notranslate"><span class="pre">otel-collector</span></code> is responsible for receiving data from applications and
forwarding it to Jaeger <em>internally</em> over the Docker network
(<code class="docutils literal notranslate"><span class="pre">jaeger:4317</span></code>).</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">restart</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">unless-stopped</span></code></p>
<ul>
<li><p>Automatically restarts the container if it crashes or the Docker daemon
restarts, unless explicitly stopped. Good for development stability.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">environment</span></code>:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SPAN_STORAGE_TYPE=memory</span></code>: <strong>Important:</strong> Configures Jaeger to store
trace data <strong>in memory only</strong>. Data is lost on restart. Suitable only
for development/demo. Production requires persistent storage like
<code class="docutils literal notranslate"><span class="pre">elasticsearch</span></code> or <code class="docutils literal notranslate"><span class="pre">cassandra</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COLLECTOR_OTLP_ENABLED=true</span></code>: (Commented out, likely default now)
Explicitly enables the OTLP receiver within Jaeger (though we send via
the OTel Collector here).</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">deploy.resources.limits</span></code>:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">cpus:</span> <span class="pre">'1'</span></code>: Limits the container to 1 CPU core.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memory:</span> <span class="pre">1G</span></code>: Limits the container to 1 GB of RAM. Prevents Jaeger from
consuming excessive host resources.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">networks</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code></p>
<ul>
<li><p>Connects Jaeger to the network so the <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code> can send data to
it using the hostname <code class="docutils literal notranslate"><span class="pre">jaeger</span></code>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="service-prometheus">
<h3>7.4 Service: <code class="docutils literal notranslate"><span class="pre">prometheus</span></code><a class="headerlink" href="#service-prometheus" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Purpose:</strong> Runs the Prometheus time-series database and monitoring system.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">image</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">prom/prometheus:${PROMETHEUS_VERSION:-v2.53.4}</span></code></p>
<ul>
<li><p>Uses the official Prometheus image, version controlled by
<code class="docutils literal notranslate"><span class="pre">PROMETHEUS_VERSION</span></code> env var.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">container_name</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">prometheus</span></code></p>
<ul>
<li><p>Sets a fixed container name.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">command</span></code>:</strong> Specifies command-line flags for Prometheus:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--config.file=/etc/prometheus/prometheus.yml</span></code>: Tells Prometheus where
to find its config file <em>inside</em> the container.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--web.enable-lifecycle</span></code>: Enables API endpoints for reloading config
(<code class="docutils literal notranslate"><span class="pre">/-/reload</span></code>) without restarting.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--web.console.libraries</span></code>, <code class="docutils literal notranslate"><span class="pre">--web.console.templates</span></code>: Paths for legacy
console templates.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">volumes</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">./config/prometheus.yml:/etc/prometheus/prometheus.yml</span></code></p>
<ul>
<li><p>Mounts the local <code class="docutils literal notranslate"><span class="pre">config/prometheus.yml</span></code> file into the container. Allows
local editing of Prometheus configuration (scrape targets, rules).
Changes require a reload (<code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-X</span> <span class="pre">POST</span> <span class="pre">http://localhost:9090/-/reload</span></code>)
or container restart.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ports</span></code>:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">9090:9090</span></code>: Exposes the Prometheus Web UI and API port. You access this
in your browser (<code class="docutils literal notranslate"><span class="pre">http://localhost:9090</span></code>).</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">networks</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code></p>
<ul>
<li><p>Connects Prometheus to the network so it can scrape the <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code>
using the target address <code class="docutils literal notranslate"><span class="pre">otel-collector:8889</span></code> (defined in
<code class="docutils literal notranslate"><span class="pre">prometheus.yml</span></code>).</p></li>
</ul>
</li>
</ul>
</section>
<section id="service-web-demo-application">
<h3>7.5 Service: <code class="docutils literal notranslate"><span class="pre">web</span></code> (Demo Application)<a class="headerlink" href="#service-web-demo-application" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Purpose:</strong> Runs the example FastAPI application (<code class="docutils literal notranslate"><span class="pre">demo/llm_app.py</span></code>) that
uses the <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> library.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">build</span></code>:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">context:</span> <span class="pre">.</span></code>: Specifies that the build context (files available during
image build) is the current directory (where <code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>
resides).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dockerfile:</span> <span class="pre">Dockerfile.local</span></code>: Tells Docker Compose to build an image
using the instructions in <code class="docutils literal notranslate"><span class="pre">Dockerfile.local</span></code> instead of pulling a
pre-built image. This Dockerfile would typically copy the application
code and install dependencies (including <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code>).</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">container_name</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">web</span></code></p>
<ul>
<li><p>Sets a fixed container name.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ports</span></code>:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">8000:8000</span></code>: Exposes the FastAPI application’s port. You can interact
with the demo API via <code class="docutils literal notranslate"><span class="pre">http://localhost:8000</span></code>.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">depends_on</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code></p>
<ul>
<li><p>Ensures the collector is started before the web application. This
increases the likelihood that the collector is ready to receive
telemetry when the app starts sending it.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">networks</span></code>:</strong> <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code></p>
<ul>
<li><p>Connects the web app to the network so it can send telemetry data to the
collector using the hostname <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code> (e.g., connecting to
<code class="docutils literal notranslate"><span class="pre">otel-collector:4317</span></code>).</p></li>
</ul>
</li>
</ul>
</section>
<section id="network-otel-demo">
<h3>7.6 Network: <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code><a class="headerlink" href="#network-otel-demo" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">networks</span></code>:</strong> Defines the custom Docker networks used by the services.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">otel-demo</span></code>:</strong> Defines a network named <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code>.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">driver:</span> <span class="pre">bridge</span></code>:</strong> Uses the standard Docker bridge network driver. This
creates a private, isolated network for the containers attached to it.
Docker provides automatic DNS resolution within this network, allowing
containers to reach each other using their service names (e.g., <code class="docutils literal notranslate"><span class="pre">web</span></code> can
reach <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code>, <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code> can reach <code class="docutils literal notranslate"><span class="pre">jaeger</span></code>).</p></li>
</ul>
</section>
<section id="volumes">
<h3>7.7 Volumes<a class="headerlink" href="#volumes" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">volumes</span></code>:</strong> Defines named volumes for persistent storage (though only
<code class="docutils literal notranslate"><span class="pre">elasticsearch-data</span></code> is defined and not currently used by Jaeger in this
config).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">elasticsearch-data</span></code>:</strong> Defines a named volume. If Jaeger were configured
to use Elasticsearch for storage, this volume could be mounted to the
Elasticsearch container to persist its data across container restarts.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">grafana-storage</span></code>:</strong> (Commented out) Would define a volume for Grafana’s
internal database if Grafana were included.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="understanding-the-collector-configuration-collector-config-yaml">
<h2>8. Understanding the Collector Configuration (<code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code>)<a class="headerlink" href="#understanding-the-collector-configuration-collector-config-yaml" title="Link to this heading">#</a></h2>
<p>This file tells the <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code> service how to behave: what data to
receive, how to process it, and where to send it.</p>
<section id="receivers">
<h3>8.1 <code class="docutils literal notranslate"><span class="pre">receivers</span></code><a class="headerlink" href="#receivers" title="Link to this heading">#</a></h3>
<p>Defines how the Collector accepts incoming telemetry data.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">otlp</span></code>:</strong> Defines a receiver named <code class="docutils literal notranslate"><span class="pre">otlp</span></code>.</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">protocols</span></code>:</strong> Specifies the protocols the <code class="docutils literal notranslate"><span class="pre">otlp</span></code> receiver should use:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">grpc</span></code>:</strong> Enables the OTLP over gRPC protocol.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoint:</span> <span class="pre">0.0.0.0:4317</span></code>: Tells the receiver to listen on all
network interfaces (<code class="docutils literal notranslate"><span class="pre">0.0.0.0</span></code>) inside the container on port
<code class="docutils literal notranslate"><span class="pre">4317</span></code>. This is the standard port for OTLP/gRPC. Your
application SDK (configured via <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code>) sends data here.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">http</span></code>:</strong> Enables the OTLP over HTTP protocol.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoint:</span> <span class="pre">0.0.0.0:4318</span></code>: Tells the receiver to listen on port
<code class="docutils literal notranslate"><span class="pre">4318</span></code>. This is the standard port for OTLP/HTTP.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="processors">
<h3>8.2 <code class="docutils literal notranslate"><span class="pre">processors</span></code><a class="headerlink" href="#processors" title="Link to this heading">#</a></h3>
<p>Defines components that process telemetry data as it flows through the
Collector. Processors are chained together in pipelines.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">batch</span></code>:</strong> Defines a batch processor.</p>
<ul>
<li><p><strong>Purpose:</strong> Groups telemetry data (spans, metrics, logs) into batches
before sending them to exporters. This improves efficiency and reduces
load on backend systems. It can provide secondary batching even if the
SDK already batches. Default settings are used if not specified.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">memory_limiter</span></code>:</strong> (Commented out)</p>
<ul>
<li><p><strong>Purpose:</strong> Protects the Collector from running out of memory under
high load.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">check_interval</span></code>: How often to check memory usage.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">limit_mib</span></code>: Memory limit in Mebibytes. If exceeded, the collector
starts refusing data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spike_limit_mib</span></code>: A higher limit to accommodate temporary spikes.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">resource</span></code>:</strong> (Commented out)</p>
<ul>
<li><p><strong>Purpose:</strong> Modifies resource attributes attached to telemetry. Can be
used to add common attributes (like region) or override existing ones.</p></li>
</ul>
</li>
</ul>
</section>
<section id="exporters">
<h3>8.3 <code class="docutils literal notranslate"><span class="pre">exporters</span></code><a class="headerlink" href="#exporters" title="Link to this heading">#</a></h3>
<p>Defines how the Collector sends telemetry data to final destinations (backends).</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">debug</span></code>:</strong> Defines an exporter that prints telemetry data to the
Collector’s console output.</p>
<ul>
<li><p><strong>Purpose:</strong> Extremely useful for debugging and verifying that data is
flowing through the collector correctly.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verbosity:</span> <span class="pre">detailed</span></code>: Prints more information.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sampling_initial</span></code>, <code class="docutils literal notranslate"><span class="pre">sampling_thereafter</span></code>: Limits the rate of output to
avoid flooding the console.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">prometheus</span></code>:</strong> Defines an exporter that makes metrics available for a
Prometheus server to scrape.</p>
<ul>
<li><p><strong>Purpose:</strong> Converts OTel metrics into the Prometheus exposition
format.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoint:</span> <span class="pre">0.0.0.0:8889</span></code>: Specifies the address and port where this
exporter will listen for scrape requests from Prometheus. The
<code class="docutils literal notranslate"><span class="pre">prometheus</span></code> service in <code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code> is configured (in its
own <code class="docutils literal notranslate"><span class="pre">prometheus.yml</span></code>) to scrape this target (<code class="docutils literal notranslate"><span class="pre">otel-collector:8889</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">namespace:</span> <span class="pre">otel_demo</span></code>: Adds a prefix (<code class="docutils literal notranslate"><span class="pre">otel_demo_</span></code>) to all metric names
exposed via this exporter. Helps avoid naming collisions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send_timestamps:</span> <span class="pre">true</span></code>: Includes timestamps with the exported metrics.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resource_to_telemetry_conversion:</span> <span class="pre">enabled:</span> <span class="pre">true</span></code>: Converts OTel
resource attributes (like <code class="docutils literal notranslate"><span class="pre">service.name</span></code>) into Prometheus labels on the
metrics.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">otlp</span></code>:</strong> Defines an exporter that sends data using the OTLP protocol
(typically to another Collector or a backend like Jaeger that supports
OTLP).</p>
<ul>
<li><p><strong>Purpose:</strong> Used here to send trace data to the Jaeger backend.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoint:</span> <span class="pre">jaeger:4317</span></code>: The address of the destination. <code class="docutils literal notranslate"><span class="pre">jaeger</span></code> is the
service name of the Jaeger container (resolved via Docker networking),
and <code class="docutils literal notranslate"><span class="pre">4317</span></code> is the port where Jaeger’s OTLP/gRPC receiver listens.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tls:</span> <span class="pre">insecure:</span> <span class="pre">true</span></code>: Disables TLS encryption for this connection. This
is acceptable <em>within</em> the private Docker network but should be <code class="docutils literal notranslate"><span class="pre">false</span></code>
(or configured properly with certificates) if sending data over
untrusted networks.</p></li>
</ul>
</li>
</ul>
</section>
<section id="extensions">
<h3>8.4 <code class="docutils literal notranslate"><span class="pre">extensions</span></code><a class="headerlink" href="#extensions" title="Link to this heading">#</a></h3>
<p>Defines additional capabilities for the Collector, not directly part of the data
pipeline.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">health_check</span></code>:</strong> Enables an HTTP endpoint that reports the Collector’s
health status.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoint:</span> <span class="pre">0.0.0.0:13133</span></code>: Makes the health check available on port
<code class="docutils literal notranslate"><span class="pre">13133</span></code>. Useful for monitoring or load balancers.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">pprof</span></code>:</strong> Enables an endpoint for Go performance profiling (<code class="docutils literal notranslate"><span class="pre">pprof</span></code>).
Useful for diagnosing Collector performance issues.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoint:</span> <span class="pre">0.0.0.0:1777</span></code>: Exposes the <code class="docutils literal notranslate"><span class="pre">pprof</span></code> endpoint.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">zpages</span></code>:</strong> Enables diagnostic web pages (<code class="docutils literal notranslate"><span class="pre">zPages</span></code>) for inspecting
internal Collector state.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoint:</span> <span class="pre">0.0.0.0:55679</span></code>: Exposes the <code class="docutils literal notranslate"><span class="pre">zPages</span></code> endpoint.</p></li>
</ul>
</li>
</ul>
</section>
<section id="service-pipelines">
<h3>8.5 <code class="docutils literal notranslate"><span class="pre">service</span></code> (Pipelines)<a class="headerlink" href="#service-pipelines" title="Link to this heading">#</a></h3>
<p>Defines how telemetry data flows through the Collector by connecting receivers,
processors, and exporters.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">extensions:</span> <span class="pre">[health_check,</span> <span class="pre">pprof,</span> <span class="pre">zpages]</span></code>:</strong> Enables the configured
extensions globally for the service.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">pipelines</span></code>:</strong> Defines data processing pipelines for each signal type
(traces, metrics, logs).</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">traces</span></code>:</strong> Defines a pipeline for trace data.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">receivers:</span> <span class="pre">[otlp]</span></code>: Receives traces from the <code class="docutils literal notranslate"><span class="pre">otlp</span></code> receiver.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">processors:</span> <span class="pre">[batch]</span></code>: Processes the traces using the <code class="docutils literal notranslate"><span class="pre">batch</span></code>
processor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exporters:</span> <span class="pre">[otlp,</span> <span class="pre">debug]</span></code>: Sends the processed traces to <em>both</em> the
<code class="docutils literal notranslate"><span class="pre">otlp</span></code> exporter (to Jaeger) and the <code class="docutils literal notranslate"><span class="pre">debug</span></code> exporter (to console).</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">metrics</span></code>:</strong> Defines a pipeline for metric data.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">receivers:</span> <span class="pre">[otlp]</span></code>: Receives metrics from the <code class="docutils literal notranslate"><span class="pre">otlp</span></code> receiver.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">processors:</span> <span class="pre">[batch]</span></code>: Processes metrics using the <code class="docutils literal notranslate"><span class="pre">batch</span></code>
processor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exporters:</span> <span class="pre">[prometheus,</span> <span class="pre">debug]</span></code>: Sends metrics to the <code class="docutils literal notranslate"><span class="pre">prometheus</span></code>
exporter (for scraping) and the <code class="docutils literal notranslate"><span class="pre">debug</span></code> exporter.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">logs</span></code>:</strong> Defines a pipeline for log data.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">receivers:</span> <span class="pre">[otlp]</span></code>: Receives logs from the <code class="docutils literal notranslate"><span class="pre">otlp</span></code> receiver.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">processors:</span> <span class="pre">[batch]</span></code>: Processes logs using the <code class="docutils literal notranslate"><span class="pre">batch</span></code> processor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exporters:</span> <span class="pre">[debug]</span></code>: Sends logs only to the <code class="docutils literal notranslate"><span class="pre">debug</span></code> exporter
(console output). <em>Note: To send logs to Loki, you would add a Loki
exporter configuration and add its name to this list.</em></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="resilience-and-lifecycle-management">
<h2>9. Resilience and Lifecycle Management<a class="headerlink" href="#resilience-and-lifecycle-management" title="Link to this heading">#</a></h2>
<p>Ensuring the telemetry system is reliable and behaves correctly during startup
and shutdown.</p>
<section id="fault-tolerance">
<h3>9.1 Fault Tolerance<a class="headerlink" href="#fault-tolerance" title="Link to this heading">#</a></h3>
<p>Mechanisms to handle failures gracefully.</p>
<ul class="simple">
<li><p><strong>Data Buffering:</strong></p>
<ul>
<li><p><strong>SDK:</strong> <code class="docutils literal notranslate"><span class="pre">BatchSpanProcessor</span></code> and <code class="docutils literal notranslate"><span class="pre">BatchLogRecordProcessor</span></code> buffer data
in memory queues (<code class="docutils literal notranslate"><span class="pre">max_queue_size</span></code>).</p></li>
<li><p><strong>Collector:</strong> The <code class="docutils literal notranslate"><span class="pre">batch</span></code> processor also buffers in memory. Optional
persistent queue processors exist for the Collector to buffer to disk if
backends are down for extended periods (not configured in this demo).</p></li>
<li><p><strong>Impact:</strong> Buffering helps handle short network blips or brief backend
unavailability but risks data loss if the component holding the buffer
crashes.</p></li>
</ul>
</li>
<li><p><strong>Retry Mechanisms:</strong></p>
<ul>
<li><p><strong>SDK Exporters:</strong> OTLP exporters have basic retry logic for transient
network errors.</p></li>
<li><p><strong>Collector Exporters:</strong> Typically implement more robust exponential
backoff retry strategies when sending data to backends fails.</p></li>
</ul>
</li>
<li><p><strong>Circuit Breaking:</strong> (Primarily in Collector)</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">memory_limiter</span></code> processor acts as a form of circuit breaking based on
resource usage.</p></li>
<li><p>Exporters might implement circuit breaking if a backend consistently
fails, preventing hammering a dead service.</p></li>
</ul>
</li>
<li><p><strong>Degraded Operations:</strong></p>
<ul>
<li><p>If telemetry initialization fails, <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> properties (<code class="docutils literal notranslate"><span class="pre">tracer</span></code>,
<code class="docutils literal notranslate"><span class="pre">meter</span></code>) might return No-Op implementations, allowing the application to
run but without generating telemetry.</p></li>
<li><p>Sampling (<code class="docutils literal notranslate"><span class="pre">SamplerFactory</span></code>) reduces data volume under normal operation,
which inherently limits impact during high load. Collector processors
can implement further load shedding.</p></li>
</ul>
</li>
</ul>
</section>
<section id="lifecycle-management">
<h3>9.2 Lifecycle Management<a class="headerlink" href="#lifecycle-management" title="Link to this heading">#</a></h3>
<p>Ensuring proper startup and shutdown.</p>
<ul>
<li><p><strong>Initialization Sequence (<code class="docutils literal notranslate"><span class="pre">Telemetry._initialize</span></code>):</strong></p>
<ol class="arabic simple">
<li><p>Loads settings (<code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code>).</p></li>
<li><p>Builds components via <code class="docutils literal notranslate"><span class="pre">TelemetryBuilder</span></code> (Resource -&gt; Propagator -&gt;
Tracing -&gt; Metrics -&gt; Logging).</p></li>
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">setup()</span></code> on each component in order, configuring global OTel
providers.</p></li>
</ol>
<ul class="simple">
<li><p><strong>Importance:</strong> Correct order ensures dependencies are met (e.g.,
Resource exists before Tracing/Metrics/Logging components are built).</p></li>
</ul>
</li>
<li><p><strong>Graceful Shutdown (<code class="docutils literal notranslate"><span class="pre">Telemetry.shutdown</span></code>,
<code class="docutils literal notranslate"><span class="pre">TelemetryComponents.shutdown_all</span></code>):</strong></p>
<ol class="arabic simple">
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> on components, typically in reverse order of setup
(<code class="docutils literal notranslate"><span class="pre">Tracing</span></code>, <code class="docutils literal notranslate"><span class="pre">Metrics</span></code>, <code class="docutils literal notranslate"><span class="pre">Logging</span></code>, <code class="docutils literal notranslate"><span class="pre">Propagator</span></code>).</p></li>
<li><p>Each component’s <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> method calls <code class="docutils literal notranslate"><span class="pre">shutdown()</span></code> on its
underlying OTel provider (<code class="docutils literal notranslate"><span class="pre">TracerProvider</span></code>, <code class="docutils literal notranslate"><span class="pre">MeterProvider</span></code>,
<code class="docutils literal notranslate"><span class="pre">LoggerProvider</span></code>).</p></li>
<li><p>Provider shutdown triggers a <strong>final flush</strong> operation on associated
processors/readers/exporters, attempting to send any buffered data.</p></li>
</ol>
<ul class="simple">
<li><p><strong>Importance:</strong> Crucial for preventing data loss. Must be called before
application exit.</p></li>
</ul>
</li>
<li><p><strong>Resource Cleanup:</strong> Shutdown methods release resources like network
connections held by exporters and terminate background threads used by batch
processors or periodic readers.</p></li>
</ul>
</section>
<section id="performance-considerations">
<h3>9.3 Performance Considerations<a class="headerlink" href="#performance-considerations" title="Link to this heading">#</a></h3>
<p>Minimizing the impact of telemetry collection on application performance.</p>
<ul class="simple">
<li><p><strong>CPU Overhead:</strong></p>
<ul>
<li><p>Creating spans and recording metrics/logs has some CPU cost.</p></li>
<li><p>Sampling (<code class="docutils literal notranslate"><span class="pre">SamplerFactory</span></code>) significantly reduces the number of traces
processed and exported.</p></li>
<li><p>Batching (SDK and Collector <code class="docutils literal notranslate"><span class="pre">batch</span></code> processors) amortizes the cost of
serialization and export over many items.</p></li>
<li><p>Using efficient protocols like OTLP/gRPC (binary Protobuf) is generally
less CPU-intensive than text-based formats.</p></li>
</ul>
</li>
<li><p><strong>Memory Usage:</strong></p>
<ul>
<li><p>In-memory buffers (batch processors, metric aggregators) consume RAM.</p></li>
<li><p>Configuration (<code class="docutils literal notranslate"><span class="pre">max_queue_size</span></code>, <code class="docutils literal notranslate"><span class="pre">batch_size</span></code>) limits buffer sizes.</p></li>
<li><p>Periodic flushing/exporting prevents unbounded buffer growth.</p></li>
<li><p>Collector <code class="docutils literal notranslate"><span class="pre">memory_limiter</span></code> provides a safety net.</p></li>
</ul>
</li>
<li><p><strong>Network Bandwidth:</strong></p>
<ul>
<li><p>Exporting telemetry consumes network bandwidth.</p></li>
<li><p>Batching reduces the number of requests and protocol overhead.</p></li>
<li><p>Binary protocols (OTLP/gRPC) are typically more compact than text/JSON
formats.</p></li>
<li><p>Sampling drastically reduces the volume of trace data sent.</p></li>
<li><p>Filtering attributes (not explicitly shown, but possible in Collector)
can reduce data size.</p></li>
</ul>
</li>
<li><p><strong>Storage Efficiency (Backends):</strong></p>
<ul>
<li><p>Backends use compression (e.g., Prometheus TSDB, Jaeger with
Elasticsearch/Cassandra).</p></li>
<li><p>Sampling reduces the amount of data needing storage.</p></li>
<li><p>Data retention policies in backends prevent indefinite storage growth.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="extensions-and-customizations">
<h2>10. Extensions and Customizations<a class="headerlink" href="#extensions-and-customizations" title="Link to this heading">#</a></h2>
<p>While <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> aims for simplicity, the underlying OpenTelemetry SDK is
highly extensible.</p>
<section id="custom-exporters">
<h3>10.1 Custom Exporters<a class="headerlink" href="#custom-exporters" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>How:</strong> You can implement the <code class="docutils literal notranslate"><span class="pre">SpanExporter</span></code>, <code class="docutils literal notranslate"><span class="pre">MetricExporter</span></code>, or
<code class="docutils literal notranslate"><span class="pre">LogExporter</span></code> interface from the OTel SDK to send data to custom backends or
formats not supported out-of-the-box.</p></li>
<li><p><strong>Integration:</strong> You would need to modify the corresponding factory
(<code class="docutils literal notranslate"><span class="pre">SpanExporterFactory</span></code>, etc.) in <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> to recognize a new
<code class="docutils literal notranslate"><span class="pre">ExporterType</span></code> and instantiate your custom exporter.</p></li>
</ul>
</section>
<section id="custom-processors">
<h3>10.2 Custom Processors<a class="headerlink" href="#custom-processors" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>How:</strong> Implement the <code class="docutils literal notranslate"><span class="pre">SpanProcessor</span></code> or <code class="docutils literal notranslate"><span class="pre">LogRecordProcessor</span></code> interface to
add custom logic to the telemetry pipeline <em>within the SDK</em>. Examples:
automatically adding specific attributes to all spans, filtering sensitive
data, or creating custom metrics based on span data.</p></li>
<li><p><strong>Integration:</strong> Modify the relevant factory (<code class="docutils literal notranslate"><span class="pre">SpanProcessorFactory</span></code>,
<code class="docutils literal notranslate"><span class="pre">LogProcessorFactory</span></code>) to create and potentially chain your custom
processor.</p></li>
</ul>
</section>
<section id="custom-samplers">
<h3>10.3 Custom Samplers<a class="headerlink" href="#custom-samplers" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>How:</strong> Implement the <code class="docutils literal notranslate"><span class="pre">Sampler</span></code> interface to create complex sampling
decisions based on trace attributes (e.g., sample all traces for a specific
user ID, sample errors at a higher rate).</p></li>
<li><p><strong>Integration:</strong> Modify <code class="docutils literal notranslate"><span class="pre">SamplerFactory</span></code> to recognize a new
<code class="docutils literal notranslate"><span class="pre">SamplingStrategy</span></code> and instantiate your custom sampler.</p></li>
</ul>
</section>
<section id="backend-integrations">
<h3>10.4 Backend Integrations<a class="headerlink" href="#backend-integrations" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The primary way to integrate with different backends is via the
<strong>OpenTelemetry Collector</strong>. The Collector has a wide range of built-in and
contributed exporters for various systems (Datadog, New Relic, Splunk,
Kafka, Loki, TimescaleDB, etc.).</p></li>
<li><p>You typically wouldn’t need to change <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> itself; instead, you
would:</p>
<ol class="arabic simple">
<li><p>Configure <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> to send data via OTLP to the Collector
(<code class="docutils literal notranslate"><span class="pre">exporter_type=ExporterType.OTLP</span></code>).</p></li>
<li><p>Configure the Collector (<code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code>) to use the appropriate
exporter for your desired backend.</p></li>
</ol>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="conclusion">
<h2>11. Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> library provides a simplified and configuration-driven approach
to instrumenting Python applications with OpenTelemetry. By wrapping the core
OTel SDK components and providing a unified <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> facade, it lowers the
barrier to entry for implementing comprehensive observability (tracing, metrics,
logging).</p>
<p>This document has provided a detailed walkthrough of:</p>
<ol class="arabic simple">
<li><p>The core concepts of observability and OpenTelemetry.</p></li>
<li><p>The architecture involving the application SDK, the OTel Collector, and
backend systems.</p></li>
<li><p>The specific code structure and components within the <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> library.</p></li>
<li><p>Detailed configuration options available via <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code>.</p></li>
<li><p>Practical examples of how to use the library to generate telemetry.</p></li>
<li><p>An end-to-end trace of how telemetry data flows through the entire system.</p></li>
<li><p>Explanations of the demo Docker Compose and Collector configurations.</p></li>
<li><p>Resilience, lifecycle, and performance considerations.</p></li>
</ol>
<p>By understanding these elements, developers new to the project should be
well-equipped to utilize <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> effectively and gain valuable insights into
their application’s behavior. Remember that the OpenTelemetry Collector is a key
component for flexibility and scalability in production environments.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="propagator_types.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Understanding Propagator Types in Distributed Tracing</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-architecture-overview">2. System Architecture Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#application-layer-your-code-cryostorm">2.1 Application Layer (Your Code + <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#opentelemetry-collector-the-data-hub">2.2 OpenTelemetry Collector (The Data Hub)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backend-systems-storage-visualization">2.3 Backend Systems (Storage &amp; Visualization)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-concepts-and-code-structure-cryostorm-library">3. Core Concepts and Code Structure (<code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> Library)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-files-and-their-purpose">3.1 Key Files and Their Purpose</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#central-facade-telemetry-class-telemetry-py">3.2 Central Facade: <code class="docutils literal notranslate"><span class="pre">Telemetry</span></code> Class (<code class="docutils literal notranslate"><span class="pre">telemetry.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-telemetrysettings-settings-py">3.3 Configuration: <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code> (<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-components-the-builder-and-factory-patterns">3.4 Building Components: The Builder and Factory Patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#component-interfaces-telemetrycomponent-and-factory-interface-py">3.5 Component Interfaces: <code class="docutils literal notranslate"><span class="pre">TelemetryComponent</span></code> and <code class="docutils literal notranslate"><span class="pre">Factory</span></code> (<code class="docutils literal notranslate"><span class="pre">interface.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-constants-enums-constants-py">3.6 Defining Constants: Enums (<code class="docutils literal notranslate"><span class="pre">constants.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-your-service-resource-resource-py">3.7 Representing Your Service: <code class="docutils literal notranslate"><span class="pre">Resource</span></code> (<code class="docutils literal notranslate"><span class="pre">resource.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-traces-tracingcomponent-trace-py">3.8 Handling Traces: <code class="docutils literal notranslate"><span class="pre">TracingComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">trace.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-metrics-metricscomponent-metric-py">3.9 Handling Metrics: <code class="docutils literal notranslate"><span class="pre">MetricsComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">metric.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-logs-loggingcomponent-log-py">3.10 Handling Logs: <code class="docutils literal notranslate"><span class="pre">LoggingComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">log.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-context-propagation-propagatorcomponent-propagator-py">3.11 Handling Context Propagation: <code class="docutils literal notranslate"><span class="pre">PropagatorComponent</span></code> (<code class="docutils literal notranslate"><span class="pre">propagator.py</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-trace-volume-sampler-sampler-py">3.12 Controlling Trace Volume: <code class="docutils literal notranslate"><span class="pre">Sampler</span></code> (<code class="docutils literal notranslate"><span class="pre">sampler.py</span></code>)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-in-detail-settings-py">4. Configuration In Detail (<code class="docutils literal notranslate"><span class="pre">settings.py</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-configuration">4.1 Loading Configuration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#main-telemetrysettings">4.2 Main <code class="docutils literal notranslate"><span class="pre">TelemetrySettings</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serviceinfo">4.3 <code class="docutils literal notranslate"><span class="pre">ServiceInfo</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collectorendpoint">4.4 <code class="docutils literal notranslate"><span class="pre">CollectorEndpoint</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exportconfig">4.5 <code class="docutils literal notranslate"><span class="pre">ExportConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#propagationconfig">4.6 <code class="docutils literal notranslate"><span class="pre">PropagationConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracingconfig">4.7 <code class="docutils literal notranslate"><span class="pre">TracingConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metricsconfig">4.8 <code class="docutils literal notranslate"><span class="pre">MetricsConfig</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loggingconfig">4.9 <code class="docutils literal notranslate"><span class="pre">LoggingConfig</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use-cryostorm-examples">5. How to Use <code class="docutils literal notranslate"><span class="pre">cryostorm</span></code> (Examples)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialization">5.1 Initialization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-traces-spans">5.2 Creating Traces (Spans)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-metrics">5.3 Creating Metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-logs">5.4 Generating Logs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#context-propagation-manual">5.5 Context Propagation (Manual)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shutdown">5.6 Shutdown</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comprehensive-telemetry-flow-model-end-to-end">6. Comprehensive Telemetry Flow Model (End-to-End)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-0-initialization-and-configuration">6.1 Phase 0: Initialization and Configuration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-1-telemetry-generation-inside-your-app">6.2 Phase 1: Telemetry Generation (Inside Your App)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-2-context-propagation-linking-services">6.3 Phase 2: Context Propagation (Linking Services)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-3-sdk-processing-and-export-sending-data-out">6.4 Phase 3: SDK Processing and Export (Sending Data Out)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-4-collector-reception-and-processing-central-hub">6.5 Phase 4: Collector Reception and Processing (Central Hub)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-5-collector-export-to-backends">6.6 Phase 5: Collector Export (To Backends)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-6-backend-storage-and-indexing-saving-data">6.7 Phase 6: Backend Storage and Indexing (Saving Data)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-7-query-and-visualization-using-data">6.8 Phase 7: Query and Visualization (Using Data)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-demo-environment-docker-compose-local-yml">7. Understanding the Demo Environment (<code class="docutils literal notranslate"><span class="pre">docker-compose-local.yml</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-docker-compose">7.1 What is Docker Compose?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-otel-collector">7.2 Service: <code class="docutils literal notranslate"><span class="pre">otel-collector</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-jaeger">7.3 Service: <code class="docutils literal notranslate"><span class="pre">jaeger</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-prometheus">7.4 Service: <code class="docutils literal notranslate"><span class="pre">prometheus</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-web-demo-application">7.5 Service: <code class="docutils literal notranslate"><span class="pre">web</span></code> (Demo Application)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-otel-demo">7.6 Network: <code class="docutils literal notranslate"><span class="pre">otel-demo</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#volumes">7.7 Volumes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-the-collector-configuration-collector-config-yaml">8. Understanding the Collector Configuration (<code class="docutils literal notranslate"><span class="pre">collector-config.yaml</span></code>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#receivers">8.1 <code class="docutils literal notranslate"><span class="pre">receivers</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processors">8.2 <code class="docutils literal notranslate"><span class="pre">processors</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exporters">8.3 <code class="docutils literal notranslate"><span class="pre">exporters</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extensions">8.4 <code class="docutils literal notranslate"><span class="pre">extensions</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-pipelines">8.5 <code class="docutils literal notranslate"><span class="pre">service</span></code> (Pipelines)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resilience-and-lifecycle-management">9. Resilience and Lifecycle Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fault-tolerance">9.1 Fault Tolerance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lifecycle-management">9.2 Lifecycle Management</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-considerations">9.3 Performance Considerations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extensions-and-customizations">10. Extensions and Customizations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-exporters">10.1 Custom Exporters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-processors">10.2 Custom Processors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-samplers">10.3 Custom Samplers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backend-integrations">10.4 Backend Integrations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">11. Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Hongnan Gao
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>